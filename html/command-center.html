<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Arduino CLI Command Center</title>
  <style>
    :root {
      color-scheme: dark;
    }

    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", sans-serif;
      background: #1e1e1e;
      color: #d4d4d4;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    header {
      display: flex;
      gap: 8px;
      align-items: center;
      padding: 8px;
      border-bottom: 1px solid #2d2d2d;
      background: #252526;
    }

    header button {
      background: transparent;
      color: #d4d4d4;
      border: 1px solid transparent;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
    }

    header button.active {
      background: #0e639c;
      border-color: #0e639c;
      color: #fff;
    }

    header button:hover:not(.active) {
      background: #2a2d2e;
      border-color: #2a2d2e;
    }

    .status {
      margin-left: auto;
      font-size: 12px;
      color: #9cdcfe;
      white-space: nowrap;
    }

    main {
      flex: 1;
      overflow: auto;
    }

    .tab-panel {
      display: none;
      padding: 12px;
      gap: 12px;
    }

    .tab-panel.active {
      display: flex;
      flex-direction: column;
    }

    .toolbar {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    input[type="text"] {
      padding: 6px 10px;
      border-radius: 4px;
      border: 1px solid #3c3c3c;
      background: #2d2d2d;
      color: #d4d4d4;
      flex: 1;
      min-width: 180px;
    }

    input[type="text"]:disabled {
      opacity: 0.6;
    }

    button.primary {
      background: #0e639c;
      border: 0;
      color: #fff;
      padding: 6px 14px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
    }

    button.primary:disabled {
      opacity: 0.6;
      cursor: default;
    }

    button.subtle {
      background: transparent;
      border: 1px solid #3c3c3c;
      color: #d4d4d4;
      padding: 4px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }

    button.subtle:hover:not(:disabled) {
      background: #2a2d2e;
    }

    button.subtle:disabled {
      opacity: 0.5;
      cursor: default;
    }

    .command-list {
      display: flex;
      flex-direction: column;
      align-items: stretch;
      gap: 10px;
      margin-top: 12px;
      width: 100%;
    }

    .command-card {
      border: 1px solid #2d2d2d;
      border-radius: 8px;
      padding: 12px 14px;
      display: flex;
      align-items: flex-start;
      gap: 16px;
      background: #252526;
      width: 100%;
      box-sizing: border-box;
    }

    .command-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .command-cli {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 12px;
      color: #9cdcfe;
    }

    .command-cli-label {
      font-weight: 600;
      color: #9cdcfe;
    }

    .command-cli-text {
      margin: 0;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      background: #1b1b1b;
      border: 1px solid #2d2d2d;
      border-radius: 4px;
      padding: 6px 8px;
      color: #c5e4ff;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .command-actions {
      display: flex;
      align-items: center;
      justify-content: center;
      align-self: stretch;
      min-width: 110px;
    }

    .command-actions button {
      min-width: 110px;
    }

    .checkbox {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      color: #ccc;
    }

    .checkbox input {
      margin: 0;
    }

    .core-note,
    .library-note {
      font-size: 12px;
      color: #ccc;
      background: #1f1f1f;
      border: 1px solid #2d2d2d;
      border-radius: 6px;
      padding: 10px 12px;
      line-height: 1.5;
    }

    .core-note strong,
    .library-note strong {
      color: #fff;
    }

    .core-toolbar,
    .library-toolbar {
      gap: 12px;
      flex-wrap: wrap;
    }

    .core-toolbar input[type="text"],
    .library-toolbar input[type="text"] {
      flex: 1;
      min-width: 220px;
    }

    .checkbox-group {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    .core-table select,
    .library-table select {
      padding: 5px 8px;
      background: #2d2d2d;
      color: #d4d4d4;
      border: 1px solid #3d3d3d;
      border-radius: 4px;
    }

    .core-name,
    .library-name {
      font-weight: 600;
    }

    .core-meta,
    .library-meta {
      color: #999;
      font-size: 11px;
      margin-top: 2px;
    }

    .core-status-cell,
    .library-status-cell {
      font-size: 12px;
      color: #ddd;
    }

    .core-action-buttons,
    .library-action-buttons {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .core-empty,
    .library-empty {
      font-size: 13px;
      color: #808080;
      text-align: center;
      margin-top: 16px;
    }

    .library-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      table-layout: fixed;
    }

    .library-table th:nth-child(1) {
      width: 32%;
    }

    .library-table th:nth-child(2),
    .library-table th:nth-child(3) {
      width: 14%;
    }

    .library-table th:nth-child(4) {
      width: 18%;
    }

    .library-table th:nth-child(5) {
      width: 22%;
    }

    .library-table th,
    .library-table td {
      overflow: hidden;
      text-overflow: ellipsis;
      vertical-align: top;
    }

    .library-name,
    .library-meta {
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .core-tag,
    .library-tag {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 4px;
      background: #094771;
      color: #fff;
      font-size: 11px;
      margin-left: 6px;
    }

    .core-row.pending,
    .library-row.pending {
      opacity: 0.6;
    }

    .core-installed,
    .library-installed {
      color: #4ec9b0;
      font-weight: 600;
    }

    .core-not-installed,
    .library-not-installed {
      color: #bbb;
    }

    .command-title {
      font-weight: 600;
      font-size: 14px;
    }

    .command-id {
      font-size: 11px;
      color: #808080;
      word-break: break-all;
    }

    .command-desc {
      font-size: 12px;
      line-height: 1.5;
    }

    .command-note {
      font-size: 12px;
      color: #d19a66;
    }

    .command-footer {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .note {
      font-size: 12px;
      color: #d19a66;
    }

    .empty {
      font-size: 13px;
      color: #808080;
      margin-top: 24px;
      text-align: center;
    }

    pre.config-dump {
      background: #1b1b1b;
      border: 1px solid #2d2d2d;
      border-radius: 6px;
      padding: 12px;
      overflow: auto;
      font-size: 12px;
      max-height: 320px;
      white-space: pre-wrap;
      word-break: break-word;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    th,
    td {
      border: 1px solid #2d2d2d;
      padding: 6px 8px;
      text-align: left;
    }

    th {
      background: #2a2d2e;
    }

    .url-actions {
      display: flex;
      gap: 6px;
    }

    .badge {
      font-size: 11px;
      color: #9cdcfe;
    }

    .hidden {
      display: none !important;
    }
  </style>
</head>

<body>
  <header>
    <button id="tabCommands" class="active" data-tab="commands"></button>
    <button id="tabConfig" data-tab="config"></button>
    <button id="tabCores" data-tab="cores"></button>
    <button id="tabLibraries" data-tab="libraries"></button>
    <span id="status" class="status"></span>
  </header>
  <main>
    <section id="panelCommands" class="tab-panel active">
      <div class="toolbar">
        <input id="filterInput" type="text" />
        <span id="profileBadge" class="badge hidden"></span>
      </div>
      <div id="commandList" class="command-list"></div>
      <div id="emptyCommands" class="empty hidden"></div>
    </section>
    <section id="panelConfig" class="tab-panel">
      <div class="toolbar">
        <button id="refreshConfig" class="primary"></button>
      </div>
      <pre id="configDump" class="config-dump"></pre>
      <div class="toolbar">
        <input id="urlInput" type="text" />
        <button id="addUrl" class="primary"></button>
      </div>
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th id="urlHeader"></th>
            <th id="actionHeader"></th>
          </tr>
        </thead>
        <tbody id="urlTable"></tbody>
      </table>
    </section>
    <section id="panelCores" class="tab-panel">
      <div class="core-note" id="coreNotice"></div>
      <div class="toolbar core-toolbar">
        <input id="coreFilter" type="text" />
        <div class="checkbox-group">
          <label class="checkbox">
            <input type="checkbox" id="coreShowInstalled" />
            <span id="coreShowInstalledLabel"></span>
          </label>
          <label class="checkbox">
            <input type="checkbox" id="coreShowUpdatable" />
            <span id="coreShowUpdatableLabel"></span>
          </label>
        </div>
        <button id="coreRefresh" class="primary"></button>
      </div>
      <table class="core-table">
        <thead>
          <tr>
            <th id="coreHeaderName"></th>
            <th id="coreHeaderLatest"></th>
            <th id="coreHeaderInstalled"></th>
            <th id="coreHeaderVersion"></th>
            <th id="coreHeaderActions"></th>
          </tr>
        </thead>
        <tbody id="coreTable"></tbody>
      </table>
      <div id="coreEmpty" class="core-empty hidden"></div>
    </section>
    <section id="panelLibraries" class="tab-panel">
      <div class="library-note" id="libraryNotice"></div>
      <div class="toolbar library-toolbar">
        <input id="libraryFilter" type="text" />
        <div class="checkbox-group">
          <label class="checkbox">
            <input type="checkbox" id="libraryShowInstalled" />
            <span id="libraryShowInstalledLabel"></span>
          </label>
          <label class="checkbox">
            <input type="checkbox" id="libraryShowUpdatable" />
            <span id="libraryShowUpdatableLabel"></span>
          </label>
        </div>
        <button id="libraryRefresh" class="primary"></button>
      </div>
      <table class="library-table">
        <thead>
          <tr>
            <th id="libraryHeaderName"></th>
            <th id="libraryHeaderLatest"></th>
            <th id="libraryHeaderInstalled"></th>
            <th id="libraryHeaderVersion"></th>
            <th id="libraryHeaderActions"></th>
          </tr>
        </thead>
        <tbody id="libraryTable"></tbody>
      </table>
      <div id="libraryEmpty" class="library-empty hidden"></div>
    </section>
  </main>
  <script>
    const vscode = acquireVsCodeApi();
    const defaultLocale = ((navigator.language || navigator.userLanguage || 'en') + '').toLowerCase().startsWith('ja') ? 'ja' : 'en';
    const state = {
      locale: defaultLocale,
      commands: [],
      filter: '',
      hasProfile: false,
      profileLabel: '',
      commandRunning: '',
      configBusy: false,
      configDump: '',
      additionalUrls: [],
      pendingRemoveIndex: -1,
      cores: [],
      coreFilter: '',
      coreShowInstalled: false,
      coreShowUpdatable: false,
      coreBusy: false,
      coreSelections: {},
      corePendingAction: null,
      libraries: [],
      libraryFilter: '',
      libraryShowInstalled: false,
      libraryShowUpdatable: false,
      libraryBusy: false,
      librarySelections: {},
      libraryPendingAction: null,
    };

    const STR = {
      ja: {
        tabCommands: 'コマンド',
        tabConfig: '設定',
        tabCores: 'コア',
        tabLibraries: 'ライブラリ',
        filterPlaceholder: 'コマンドを検索',
        run: '実行',
        running: '実行中…',
        commandId: 'コマンド ID',
        commandCliLabel: '実行コマンド',
        requiresProfile: 'プロファイルが必要です',
        noCommands: '一致するコマンドはありません。',
        activeProfile: (label) => label ? `選択中: ${label}` : '',
        configDumpPlaceholder: 'arduino-cli config dump の結果がここに表示されます。',
        refreshConfig: '設定を更新',
        addUrl: 'URL を追加',
        urlPlaceholder: '追加するボードマネージャー URL',
        urlHeader: '追加 URL',
        actionHeader: '操作',
        delete: '削除',
        deleting: '削除中…',
        adding: '追加中…',
        profileMissing: 'プロファイルが未設定のため実行できません。',
        confirmRemovePrompt: 'もう一度押すと削除します。',
        confirmRemoveNow: '削除する',
        statusRefresh: '設定を更新しました。',
        statusAdd: 'URL を追加しました。',
        statusRemove: 'URL を削除しました。',
        statusError: 'エラー: {msg}',
        statusBusy: '処理中…',
        invalidUrl: '有効な URL を入力してください。',
        coreNotice: 'この一覧では sketch.yaml でバージョンを固定していない場合に使用される Arduino コアの既定バージョンを管理します。推奨は各プロジェクトでバージョンを指定することであり、ここでインストールしたコアは Arduino IDE でも利用できます。',
        coreFilterPlaceholder: 'コア名／プラットフォーム／メンテナーで絞り込み',
        coreShowInstalled: 'インストール済みのみ',
        coreShowUpdatable: 'アップデート可能のみ',
        coreHeaderName: 'コア',
        coreHeaderLatest: '最新バージョン',
        coreHeaderInstalled: 'インストール済み',
        coreHeaderVersion: '選択バージョン',
        coreHeaderActions: '操作',
        coreRefresh: '一覧を更新',
        coreInstall: 'インストール',
        coreInstallSelected: '選択をインストール',
        coreReinstall: '再インストール',
        coreUpdate: '最新に更新',
        coreUninstall: 'アンインストール',
        coreLoading: 'コア情報を取得しています…',
        coreNoData: 'コア情報が未取得です。更新ボタンで取得してください。',
        coreNoMatch: 'フィルター条件に一致するコアがありません。',
        coreInstalledLabel: 'バージョン {version}',
        coreNotInstalledLabel: '未インストール',
        coreUpdateTag: '更新可能',
        coreLatestTag: '最新',
        coreOptionInstalled: ' (インストール済み)',
        coreOptionLatest: ' (最新)',
        libraryNotice: 'この一覧では sketch.yaml でバージョンを固定していない場合に使用される Arduino ライブラリの既定バージョンを管理します。推奨は各プロジェクトでバージョンを指定することであり、ここでインストールしたライブラリは Arduino IDE でも利用できます。',
        libraryFilterPlaceholder: 'ライブラリ名／作者／説明で絞り込み',
        libraryShowInstalled: 'インストール済みのみ',
        libraryShowUpdatable: 'アップデート可能のみ',
        libraryHeaderName: 'ライブラリ',
        libraryHeaderLatest: '最新バージョン',
        libraryHeaderInstalled: 'インストール済み',
        libraryHeaderVersion: '選択バージョン',
        libraryHeaderActions: '操作',
        libraryRefresh: '一覧を更新',
        libraryInstall: 'インストール',
        libraryInstallSelected: '選択をインストール',
        libraryReinstall: '再インストール',
        libraryUpdate: '最新に更新',
        libraryUninstall: 'アンインストール',
        libraryLoading: 'ライブラリ情報を取得しています…',
        libraryNoData: 'ライブラリ情報が未取得です。更新ボタンで取得してください。',
        libraryNoMatch: 'フィルター条件に一致するライブラリがありません。',
        libraryInstalledLabel: 'バージョン {version}',
        libraryNotInstalledLabel: '未インストール',
        libraryUpdateTag: '更新可能',
        libraryLatestTag: '最新',
        libraryOptionInstalled: ' (インストール済み)',
        libraryOptionLatest: ' (最新)',
      },
      en: {
        tabCommands: 'Commands',
        tabConfig: 'Settings',
        tabCores: 'Cores',
        tabLibraries: 'Libraries',
        filterPlaceholder: 'Search commands',
        run: 'Run',
        running: 'Running…',
        commandId: 'Command ID',
        commandCliLabel: 'CLI Command',
        requiresProfile: 'Profile required',
        noCommands: 'No commands match the filter.',
        activeProfile: (label) => label ? `Profile: ${label}` : '',
        configDumpPlaceholder: 'Output from `arduino-cli config dump` will appear here.',
        refreshConfig: 'Refresh',
        addUrl: 'Add URL',
        urlPlaceholder: 'Board Manager URL to add',
        urlHeader: 'Additional URL',
        actionHeader: 'Action',
        delete: 'Remove',
        deleting: 'Removing…',
        adding: 'Adding…',
        profileMissing: 'Cannot run because no profile is selected.',
        confirmRemovePrompt: 'Click again to delete.',
        confirmRemoveNow: 'Confirm Delete',
        statusRefresh: 'Configuration refreshed.',
        statusAdd: 'URL added.',
        statusRemove: 'URL removed.',
        statusError: 'Error: {msg}',
        statusBusy: 'Working…',
        invalidUrl: 'Enter a valid URL.',
        coreNotice: 'Manage default Arduino core versions used when sketch.yaml does not pin an explicit release. Projects should prefer pinning versions inside sketch.yaml; any core installed here is also available to the Arduino IDE.',
        coreFilterPlaceholder: 'Filter cores (name/platform/maintainer)',
        coreShowInstalled: 'Installed only',
        coreShowUpdatable: 'Update available',
        coreHeaderName: 'Core',
        coreHeaderLatest: 'Latest',
        coreHeaderInstalled: 'Installed',
        coreHeaderVersion: 'Selected version',
        coreHeaderActions: 'Actions',
        coreRefresh: 'Refresh List',
        coreInstall: 'Install',
        coreInstallSelected: 'Install Selected',
        coreReinstall: 'Reinstall',
        coreUpdate: 'Update to Latest',
        coreUninstall: 'Uninstall',
        coreLoading: 'Loading cores…',
        coreNoData: 'Core data has not been loaded yet. Use Refresh to retrieve it.',
        coreNoMatch: 'No cores match the current filters.',
        coreInstalledLabel: 'Version {version}',
        coreNotInstalledLabel: 'Not installed',
        coreUpdateTag: 'Update available',
        coreLatestTag: 'Latest',
        coreOptionInstalled: ' (installed)',
        coreOptionLatest: ' (latest)',
        libraryNotice: 'Manage default Arduino libraries used when sketch.yaml does not pin an explicit release. Projects should prefer pinning versions inside sketch.yaml; any library installed here is also available to the Arduino IDE.',
        libraryFilterPlaceholder: 'Filter libraries (name/author/description)',
        libraryShowInstalled: 'Installed only',
        libraryShowUpdatable: 'Update available',
        libraryHeaderName: 'Library',
        libraryHeaderLatest: 'Latest',
        libraryHeaderInstalled: 'Installed',
        libraryHeaderVersion: 'Selected version',
        libraryHeaderActions: 'Actions',
        libraryRefresh: 'Refresh List',
        libraryInstall: 'Install',
        libraryInstallSelected: 'Install Selected',
        libraryReinstall: 'Reinstall',
        libraryUpdate: 'Update to Latest',
        libraryUninstall: 'Uninstall',
        libraryLoading: 'Loading libraries…',
        libraryNoData: 'Library data has not been loaded yet. Use Refresh to retrieve it.',
        libraryNoMatch: 'No libraries match the current filters.',
        libraryInstalledLabel: 'Version {version}',
        libraryNotInstalledLabel: 'Not installed',
        libraryUpdateTag: 'Update available',
        libraryLatestTag: 'Latest',
        libraryOptionInstalled: ' (installed)',
        libraryOptionLatest: ' (latest)',
      }
    };

    const tabButtons = {
      commands: document.getElementById('tabCommands'),
      config: document.getElementById('tabConfig'),
      cores: document.getElementById('tabCores'),
      libraries: document.getElementById('tabLibraries'),
    };
    const panels = {
      commands: document.getElementById('panelCommands'),
      config: document.getElementById('panelConfig'),
      cores: document.getElementById('panelCores'),
      libraries: document.getElementById('panelLibraries'),
    };
    const statusEl = document.getElementById('status');
    const filterInput = document.getElementById('filterInput');
    const commandList = document.getElementById('commandList');
    const emptyCommands = document.getElementById('emptyCommands');
    const profileBadge = document.getElementById('profileBadge');
    const coreNotice = document.getElementById('coreNotice');
    const coreFilterInput = document.getElementById('coreFilter');
    const coreShowInstalledToggle = document.getElementById('coreShowInstalled');
    const coreShowInstalledLabel = document.getElementById('coreShowInstalledLabel');
    const coreShowUpdatableToggle = document.getElementById('coreShowUpdatable');
    const coreShowUpdatableLabel = document.getElementById('coreShowUpdatableLabel');
    const coreRefreshBtn = document.getElementById('coreRefresh');
    const coreHeaderName = document.getElementById('coreHeaderName');
    const coreHeaderLatest = document.getElementById('coreHeaderLatest');
    const coreHeaderInstalled = document.getElementById('coreHeaderInstalled');
    const coreHeaderVersion = document.getElementById('coreHeaderVersion');
    const coreHeaderActions = document.getElementById('coreHeaderActions');
    const coreTable = document.getElementById('coreTable');
    const coreEmpty = document.getElementById('coreEmpty');
    const libraryNotice = document.getElementById('libraryNotice');
    const libraryFilterInput = document.getElementById('libraryFilter');
    const libraryShowInstalledToggle = document.getElementById('libraryShowInstalled');
    const libraryShowInstalledLabel = document.getElementById('libraryShowInstalledLabel');
    const libraryShowUpdatableToggle = document.getElementById('libraryShowUpdatable');
    const libraryShowUpdatableLabel = document.getElementById('libraryShowUpdatableLabel');
    const libraryRefreshBtn = document.getElementById('libraryRefresh');
    const libraryHeaderName = document.getElementById('libraryHeaderName');
    const libraryHeaderLatest = document.getElementById('libraryHeaderLatest');
    const libraryHeaderInstalled = document.getElementById('libraryHeaderInstalled');
    const libraryHeaderVersion = document.getElementById('libraryHeaderVersion');
    const libraryHeaderActions = document.getElementById('libraryHeaderActions');
    const libraryTable = document.getElementById('libraryTable');
    const libraryEmpty = document.getElementById('libraryEmpty');
    const configDump = document.getElementById('configDump');
    const refreshBtn = document.getElementById('refreshConfig');
    const urlInput = document.getElementById('urlInput');
    const addUrlBtn = document.getElementById('addUrl');
    const urlTable = document.getElementById('urlTable');
    const urlHeader = document.getElementById('urlHeader');
    const actionHeader = document.getElementById('actionHeader');

    let activeTab = 'commands';

    function getLocale() {
      return state.locale === 'ja' ? 'ja' : 'en';
    }

    function text(key, vars) {
      const lang = getLocale();
      const str = STR[lang][key];
      if (typeof str === 'function') return str(vars);
      if (typeof str === 'string') {
        if (!vars) return str;
        return str.replace(/\{(\w+)\}/g, (_, k) => vars && vars[k] != null ? String(vars[k]) : '');
      }
      return '';
    }

    function escapeHtml(s) {
      const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
      return String(s ?? '').replace(/[&<>"']/g, (ch) => map[ch]);
    }

    function setLocale(locale) {
      if (locale !== 'ja' && locale !== 'en') return;
      state.locale = locale;
      document.documentElement.lang = locale;
      applyStaticTexts();
      renderCommands();
      renderCores();
      renderLibraries();
      renderConfig();
    }

    function applyStaticTexts() {
      tabButtons.commands.textContent = text('tabCommands');
      tabButtons.config.textContent = text('tabConfig');
      tabButtons.cores.textContent = text('tabCores');
      tabButtons.libraries.textContent = text('tabLibraries');
      if (filterInput) filterInput.placeholder = text('filterPlaceholder');
      if (coreFilterInput) coreFilterInput.placeholder = text('coreFilterPlaceholder');
      if (coreShowInstalledLabel) coreShowInstalledLabel.textContent = text('coreShowInstalled');
      if (coreShowUpdatableLabel) coreShowUpdatableLabel.textContent = text('coreShowUpdatable');
      if (coreRefreshBtn) coreRefreshBtn.textContent = text('coreRefresh');
      if (coreNotice) coreNotice.textContent = text('coreNotice');
      if (coreHeaderName) coreHeaderName.textContent = text('coreHeaderName');
      if (coreHeaderLatest) coreHeaderLatest.textContent = text('coreHeaderLatest');
      if (coreHeaderInstalled) coreHeaderInstalled.textContent = text('coreHeaderInstalled');
      if (coreHeaderVersion) coreHeaderVersion.textContent = text('coreHeaderVersion');
      if (coreHeaderActions) coreHeaderActions.textContent = text('coreHeaderActions');
      if (libraryFilterInput) libraryFilterInput.placeholder = text('libraryFilterPlaceholder');
      if (libraryShowInstalledLabel) libraryShowInstalledLabel.textContent = text('libraryShowInstalled');
      if (libraryShowUpdatableLabel) libraryShowUpdatableLabel.textContent = text('libraryShowUpdatable');
      if (libraryRefreshBtn) libraryRefreshBtn.textContent = text('libraryRefresh');
      if (libraryNotice) libraryNotice.textContent = text('libraryNotice');
      if (libraryHeaderName) libraryHeaderName.textContent = text('libraryHeaderName');
      if (libraryHeaderLatest) libraryHeaderLatest.textContent = text('libraryHeaderLatest');
      if (libraryHeaderInstalled) libraryHeaderInstalled.textContent = text('libraryHeaderInstalled');
      if (libraryHeaderVersion) libraryHeaderVersion.textContent = text('libraryHeaderVersion');
      if (libraryHeaderActions) libraryHeaderActions.textContent = text('libraryHeaderActions');
      refreshBtn.textContent = text('refreshConfig');
      addUrlBtn.textContent = text('addUrl');
      urlInput.placeholder = text('urlPlaceholder');
      configDump.textContent = state.configDump ? state.configDump : text('configDumpPlaceholder');
      urlHeader.textContent = text('urlHeader');
      actionHeader.textContent = text('actionHeader');
      updateProfileBadge();
    }

    function setStatus(message, sticky = false) {
      statusEl.textContent = message || '';
      if (!message) return;
      if (!sticky) {
        window.setTimeout(() => {
          statusEl.textContent = '';
        }, 3000);
      }
    }

    function switchTab(tab) {
      if (!panels[tab]) return;
      activeTab = tab;
      Object.entries(tabButtons).forEach(([key, btn]) => {
        if (!btn) return;
        btn.classList.toggle('active', key === tab);
      });
      Object.entries(panels).forEach(([key, panel]) => {
        if (!panel) return;
        panel.classList.toggle('active', key === tab);
      });
      if (tab !== 'config' && state.pendingRemoveIndex !== -1) {
        state.pendingRemoveIndex = -1;
        renderConfig();
      }
      if (tab === 'cores') {
        renderCores();
        requestCores(false);
      }
      if (tab !== 'libraries' && state.libraryPendingAction) {
        state.libraryPendingAction = null;
        renderLibraries();
      }
      if (tab === 'libraries') {
        renderLibraries();
        requestLibraries(false);
      }
    }

    function setCommandRunning(id, running) {
      if (running) {
        state.commandRunning = id;
        setStatus(text('statusBusy'), true);
      } else if (state.commandRunning === id) {
        state.commandRunning = '';
      }
      renderCommands();
    }

    function setConfigBusy(busy) {
      state.configBusy = !!busy;
      if (busy) state.pendingRemoveIndex = -1;
      const disabled = state.configBusy;
      refreshBtn.disabled = disabled;
      addUrlBtn.disabled = disabled;
      filterInput.disabled = state.commandRunning && activeTab === 'commands';
      if (disabled) {
        setStatus(text('statusBusy'), true);
      } else if (!state.commandRunning) {
        setStatus('');
      }
      renderConfig();
    }

    function updateProfileBadge() {
      const label = state.hasProfile ? text('activeProfile', state.profileLabel) : '';
      if (label) {
        profileBadge.textContent = label;
        profileBadge.classList.remove('hidden');
      } else {
        profileBadge.textContent = '';
        profileBadge.classList.add('hidden');
      }
    }

    function renderCommands() {
      if (!commandList) return;
      const filter = (state.filter || '').toLowerCase();
      commandList.innerHTML = '';
      let visibleCount = 0;
      state.commands.forEach((cmd) => {
        const cliText = typeof cmd.cli === 'string' ? cmd.cli : '';
        const haystack = `${cmd.title} ${cmd.description} ${cmd.command} ${cliText}`.toLowerCase();
        if (filter && !haystack.includes(filter)) return;
        visibleCount += 1;
        const card = document.createElement('div');
        card.className = 'command-card';

        const info = document.createElement('div');
        info.className = 'command-info';
        const title = document.createElement('div');
        title.className = 'command-title';
        title.textContent = cmd.title;
        info.appendChild(title);

        const commandId = document.createElement('div');
        commandId.className = 'command-id';
        commandId.textContent = `${text('commandId')}: ${cmd.command}`;
        info.appendChild(commandId);

        const desc = document.createElement('div');
        desc.className = 'command-desc';
        desc.textContent = cmd.description;
        info.appendChild(desc);

        if (cliText) {
          const cliWrap = document.createElement('div');
          cliWrap.className = 'command-cli';
          const cliLabel = document.createElement('div');
          cliLabel.className = 'command-cli-label';
          cliLabel.textContent = text('commandCliLabel');
          cliWrap.appendChild(cliLabel);
          const cliValue = document.createElement('pre');
          cliValue.className = 'command-cli-text';
          cliValue.textContent = cliText;
          cliWrap.appendChild(cliValue);
          info.appendChild(cliWrap);
        }

        const requiresProfile = !!cmd.requiresProfile;
        const hasProfile = !!state.hasProfile;

        if (requiresProfile && !hasProfile) {
          const note = document.createElement('div');
          note.className = 'command-note';
          note.textContent = text('profileMissing');
          info.appendChild(note);
        }

        const actions = document.createElement('div');
        actions.className = 'command-actions';
        const runButton = document.createElement('button');
        runButton.className = 'primary';
        const isDisabled = (requiresProfile && !hasProfile) || !!state.commandRunning;
        runButton.disabled = isDisabled;
        runButton.textContent = state.commandRunning === cmd.command ? text('running') : text('run');
        runButton.addEventListener('click', () => {
          if (state.commandRunning) return;
          if (requiresProfile && !hasProfile) {
            setStatus(text('profileMissing'));
            return;
          }
          vscode.postMessage({ type: 'runCommand', command: cmd.command });
        });
        actions.appendChild(runButton);

        card.appendChild(info);
        card.appendChild(actions);
        commandList.appendChild(card);
      });
      emptyCommands.classList.toggle('hidden', visibleCount > 0);
      emptyCommands.textContent = visibleCount === 0 ? text('noCommands') : '';
    }

    function requestCores(force = false) {
      if (state.coreBusy) {
        return;
      }
      if (!force && state.cores && state.cores.length > 0) return;
      state.coreBusy = true;
      renderCores();
      vscode.postMessage({ type: 'loadCores' });
    }

    function renderCores() {
      if (!coreTable) return;
      if (coreNotice) coreNotice.textContent = text('coreNotice');
      if (coreFilterInput && coreFilterInput.value !== state.coreFilter) coreFilterInput.value = state.coreFilter;
      if (coreShowInstalledToggle) coreShowInstalledToggle.checked = !!state.coreShowInstalled;
      if (coreShowUpdatableToggle) coreShowUpdatableToggle.checked = !!state.coreShowUpdatable;
      const controlsLocked = state.coreBusy || !!state.corePendingAction;
      if (coreFilterInput) coreFilterInput.disabled = controlsLocked;
      if (coreShowInstalledToggle) coreShowInstalledToggle.disabled = controlsLocked;
      if (coreShowUpdatableToggle) coreShowUpdatableToggle.disabled = controlsLocked;
      if (coreRefreshBtn) coreRefreshBtn.disabled = controlsLocked;
      const cores = Array.isArray(state.cores) ? state.cores : [];
      const filterText = (state.coreFilter || '').trim().toLowerCase();
      const showInstalled = !!state.coreShowInstalled;
      const showUpdatable = !!state.coreShowUpdatable;
      const filtered = cores.filter((core) => {
        if (showInstalled && !core.installed) return false;
        if (showUpdatable && !core.updateAvailable) return false;
        if (filterText) {
          const haystack = [
            core.title,
            core.name,
            core.maintainer,
            core.description,
            core.latestVersion,
            core.installedVersion,
          ].map((s) => (s || '').toString().toLowerCase()).join(' ');
          if (!haystack.includes(filterText)) return false;
        }
        return true;
      });
      coreTable.innerHTML = '';
      filtered.forEach((core) => {
        const tr = document.createElement('tr');
        tr.className = 'core-row';
        const pending = state.corePendingAction && state.corePendingAction.name === core.name;
        if (pending) tr.classList.add('pending');
        const infoCell = document.createElement('td');
        const nameParts = [escapeHtml(core.title || core.name)];
        if (core.updateAvailable) {
          nameParts.push(`<span class="core-tag">${escapeHtml(text('coreUpdateTag'))}</span>`);
        }
        if (!core.installed && !core.updateAvailable && core.latestVersion) {
          nameParts.push(`<span class="core-tag">${escapeHtml(text('coreLatestTag'))}</span>`);
        }
        infoCell.innerHTML = `<div class="core-name">${nameParts.join(' ')}</div>`;
        const metaParts = [];
        if (core.maintainer) metaParts.push(escapeHtml(core.maintainer));
        if (core.description) metaParts.push(escapeHtml(core.description));
        if (metaParts.length > 0) {
          infoCell.innerHTML += `<div class="core-meta">${metaParts.join(' · ')}</div>`;
        }
        tr.appendChild(infoCell);

        const latestCell = document.createElement('td');
        latestCell.className = 'core-status-cell';
        latestCell.textContent = core.latestVersion ? core.latestVersion : '—';
        tr.appendChild(latestCell);

        const installedCell = document.createElement('td');
        installedCell.className = 'core-status-cell';
        if (core.installed) {
          const installedLabel = text('coreInstalledLabel', { version: core.installedVersion || '-' });
          installedCell.innerHTML = `<span class="core-installed">${escapeHtml(installedLabel)}</span>`;
          if (core.updateAvailable) {
            installedCell.innerHTML += `<span class="core-tag">${escapeHtml(text('coreUpdateTag'))}</span>`;
          }
        } else {
          installedCell.innerHTML = `<span class="core-not-installed">${escapeHtml(text('coreNotInstalledLabel'))}</span>`;
        }
        tr.appendChild(installedCell);

        const versionCell = document.createElement('td');
        const select = document.createElement('select');
        const versions = Array.isArray(core.versions) ? core.versions.slice() : [];
        const defaultSelectionRaw = state.coreSelections[core.name] || core.installedVersion || core.latestVersion || versions[0] || '';
        if (defaultSelectionRaw && !versions.includes(defaultSelectionRaw)) versions.push(defaultSelectionRaw);
        const uniqueVersions = Array.from(new Set(versions.filter((v) => v)));
        uniqueVersions.sort((a, b) => b.localeCompare(a, undefined, { numeric: true, sensitivity: 'base' }));
        state.coreSelections[core.name] = defaultSelectionRaw;
        uniqueVersions.forEach((version) => {
          const option = document.createElement('option');
          let label = version;
          if (core.installedVersion && version === core.installedVersion) label += text('coreOptionInstalled');
          if (core.latestVersion && version === core.latestVersion) label += text('coreOptionLatest');
          option.value = version;
          option.textContent = label;
          select.appendChild(option);
        });
        select.value = defaultSelectionRaw;
        select.disabled = controlsLocked;
        select.addEventListener('change', (event) => {
          state.coreSelections[core.name] = event.target.value || '';
          renderCores();
        });
        versionCell.appendChild(select);
        tr.appendChild(versionCell);

        const actionsCell = document.createElement('td');
        const actionsWrap = document.createElement('div');
        actionsWrap.className = 'core-action-buttons';
        const selectedVersion = state.coreSelections[core.name] || '';
        const installBtn = document.createElement('button');
        installBtn.className = 'primary';
        let installLabel = text('coreInstall');
        if (!core.installed && selectedVersion && selectedVersion !== core.latestVersion) {
          installLabel = text('coreInstallSelected');
        } else if (core.installed) {
          installLabel = selectedVersion === core.installedVersion ? text('coreReinstall') : text('coreInstallSelected');
        }
        installBtn.textContent = installLabel;
        installBtn.disabled = controlsLocked || !selectedVersion;
        installBtn.addEventListener('click', () => {
          if (controlsLocked) return;
          if (!selectedVersion) return;
          vscode.postMessage({ type: 'installCore', name: core.name, version: selectedVersion });
        });
        actionsWrap.appendChild(installBtn);

        if (core.updateAvailable && core.latestVersion) {
          const updateBtn = document.createElement('button');
          updateBtn.className = 'primary';
          updateBtn.textContent = text('coreUpdate');
          updateBtn.disabled = controlsLocked;
          updateBtn.addEventListener('click', () => {
            if (controlsLocked) return;
            state.coreSelections[core.name] = core.latestVersion;
            renderCores();
            vscode.postMessage({ type: 'installCore', name: core.name, version: core.latestVersion });
          });
          actionsWrap.appendChild(updateBtn);
        }

        if (core.installed) {
          const uninstallBtn = document.createElement('button');
          uninstallBtn.className = 'subtle';
          uninstallBtn.textContent = text('coreUninstall');
          uninstallBtn.disabled = controlsLocked;
          uninstallBtn.addEventListener('click', () => {
            if (controlsLocked) return;
            vscode.postMessage({ type: 'uninstallCore', name: core.name });
          });
          actionsWrap.appendChild(uninstallBtn);
        }

        actionsCell.appendChild(actionsWrap);
        tr.appendChild(actionsCell);
        coreTable.appendChild(tr);
      });

      if (filtered.length === 0) {
        coreEmpty.classList.remove('hidden');
        if (state.coreBusy) coreEmpty.textContent = text('coreLoading');
        else if (!cores.length) coreEmpty.textContent = text('coreNoData');
        else coreEmpty.textContent = text('coreNoMatch');
      } else {
        coreEmpty.classList.add('hidden');
      }
    }

    function requestLibraries(force = false) {
      if (state.libraryBusy) return;
      if (!force && state.libraries && state.libraries.length > 0) return;
      state.libraryBusy = true;
      renderLibraries();
      vscode.postMessage({ type: 'loadLibraries' });
    }

    function renderLibraries() {
      if (!libraryTable) return;
      if (libraryNotice) libraryNotice.textContent = text('libraryNotice');
      if (libraryFilterInput && libraryFilterInput.value !== state.libraryFilter) libraryFilterInput.value = state.libraryFilter;
      if (libraryShowInstalledToggle) libraryShowInstalledToggle.checked = !!state.libraryShowInstalled;
      if (libraryShowUpdatableToggle) libraryShowUpdatableToggle.checked = !!state.libraryShowUpdatable;
      const controlsLocked = state.libraryBusy || !!state.libraryPendingAction;
      if (libraryFilterInput) libraryFilterInput.disabled = controlsLocked;
      if (libraryShowInstalledToggle) libraryShowInstalledToggle.disabled = controlsLocked;
      if (libraryShowUpdatableToggle) libraryShowUpdatableToggle.disabled = controlsLocked;
      if (libraryRefreshBtn) libraryRefreshBtn.disabled = controlsLocked;
      const libraries = Array.isArray(state.libraries) ? state.libraries : [];
      const filterText = (state.libraryFilter || '').trim().toLowerCase();
      const showInstalled = !!state.libraryShowInstalled;
      const showUpdatable = !!state.libraryShowUpdatable;
      const filtered = libraries.filter((lib) => {
        if (showInstalled && !lib.installed) return false;
        if (showUpdatable && !lib.updateAvailable) return false;
        if (filterText) {
          const haystack = [
            lib.title,
            lib.name,
            lib.author,
            lib.maintainer,
            lib.sentence,
            lib.paragraph,
            lib.latestVersion,
            lib.installedVersion,
          ].map((s) => (s || '').toString().toLowerCase()).join(' ');
          if (!haystack.includes(filterText)) return false;
        }
        return true;
      });
      libraryTable.innerHTML = '';
      filtered.forEach((lib) => {
        const tr = document.createElement('tr');
        tr.className = 'library-row';
        const pending = state.libraryPendingAction && state.libraryPendingAction.name === lib.name;
        if (pending) tr.classList.add('pending');
        const infoCell = document.createElement('td');
        const nameParts = [escapeHtml(lib.title || lib.name)];
        if (lib.updateAvailable) nameParts.push(`<span class="library-tag">${escapeHtml(text('libraryUpdateTag'))}</span>`);
        if (!lib.installed && !lib.updateAvailable && lib.latestVersion) nameParts.push(`<span class="library-tag">${escapeHtml(text('libraryLatestTag'))}</span>`);
        infoCell.innerHTML = `<div class="library-name">${nameParts.join(' ')}</div>`;
        const metaParts = [];
        if (lib.author) metaParts.push(escapeHtml(lib.author));
        if (lib.maintainer && lib.maintainer !== lib.author) metaParts.push(escapeHtml(lib.maintainer));
        if (lib.sentence) metaParts.push(escapeHtml(lib.sentence));
        if (lib.paragraph && metaParts.length < 3) metaParts.push(escapeHtml(lib.paragraph));
        if (metaParts.length > 0) infoCell.innerHTML += `<div class="library-meta">${metaParts.join(' · ')}</div>`;
        tr.appendChild(infoCell);

        const latestCell = document.createElement('td');
        latestCell.className = 'library-status-cell';
        latestCell.textContent = lib.latestVersion ? lib.latestVersion : '—';
        tr.appendChild(latestCell);

        const installedCell = document.createElement('td');
        installedCell.className = 'library-status-cell';
        if (lib.installed) {
          const label = text('libraryInstalledLabel', { version: lib.installedVersion || '-' });
          installedCell.innerHTML = `<span class="library-installed">${escapeHtml(label)}</span>`;
          if (lib.updateAvailable) installedCell.innerHTML += `<span class="library-tag">${escapeHtml(text('libraryUpdateTag'))}</span>`;
        } else {
          installedCell.innerHTML = `<span class="library-not-installed">${escapeHtml(text('libraryNotInstalledLabel'))}</span>`;
        }
        tr.appendChild(installedCell);

        const versionCell = document.createElement('td');
        const select = document.createElement('select');
        const versions = Array.isArray(lib.versions) ? lib.versions.slice() : [];
        const defaultSelection = state.librarySelections[lib.name] || lib.installedVersion || lib.latestVersion || versions[0] || '';
        if (defaultSelection && !versions.includes(defaultSelection)) versions.push(defaultSelection);
        const uniqueVersions = Array.from(new Set(versions.filter(Boolean)));
        uniqueVersions.sort((a, b) => b.localeCompare(a, undefined, { numeric: true, sensitivity: 'base' }));
        state.librarySelections[lib.name] = defaultSelection;
        uniqueVersions.forEach((version) => {
          const option = document.createElement('option');
          let label = version;
          if (lib.installedVersion && version === lib.installedVersion) label += text('libraryOptionInstalled');
          if (lib.latestVersion && version === lib.latestVersion) label += text('libraryOptionLatest');
          option.value = version;
          option.textContent = label;
          select.appendChild(option);
        });
        select.value = defaultSelection;
        select.disabled = controlsLocked;
        select.addEventListener('change', (event) => {
          state.librarySelections[lib.name] = event.target.value || '';
          renderLibraries();
        });
        versionCell.appendChild(select);
        tr.appendChild(versionCell);

        const actionsCell = document.createElement('td');
        const actionsWrap = document.createElement('div');
        actionsWrap.className = 'library-action-buttons';
        const selectedVersion = state.librarySelections[lib.name] || '';
        const installBtn = document.createElement('button');
        installBtn.className = 'primary';
        let installLabel = text('libraryInstall');
        if (!lib.installed && selectedVersion && selectedVersion !== lib.latestVersion) installLabel = text('libraryInstallSelected');
        else if (lib.installed) installLabel = selectedVersion === lib.installedVersion ? text('libraryReinstall') : text('libraryInstallSelected');
        installBtn.textContent = installLabel;
        installBtn.disabled = controlsLocked || !selectedVersion;
        installBtn.addEventListener('click', () => {
          if (controlsLocked || !selectedVersion) return;
          vscode.postMessage({ type: 'installLibrary', name: lib.name, version: selectedVersion });
        });
        actionsWrap.appendChild(installBtn);

        if (lib.updateAvailable && lib.latestVersion) {
          const updateBtn = document.createElement('button');
          updateBtn.className = 'primary';
          updateBtn.textContent = text('libraryUpdate');
          updateBtn.disabled = controlsLocked;
          updateBtn.addEventListener('click', () => {
            if (controlsLocked) return;
            state.librarySelections[lib.name] = lib.latestVersion;
            renderLibraries();
            vscode.postMessage({ type: 'installLibrary', name: lib.name, version: lib.latestVersion });
          });
          actionsWrap.appendChild(updateBtn);
        }

        if (lib.installed) {
          const uninstallBtn = document.createElement('button');
          uninstallBtn.className = 'subtle';
          uninstallBtn.textContent = text('libraryUninstall');
          uninstallBtn.disabled = controlsLocked;
          uninstallBtn.addEventListener('click', () => {
            if (controlsLocked) return;
            vscode.postMessage({ type: 'uninstallLibrary', name: lib.name });
          });
          actionsWrap.appendChild(uninstallBtn);
        }

        actionsCell.appendChild(actionsWrap);
        tr.appendChild(actionsCell);
        libraryTable.appendChild(tr);
      });

      if (filtered.length === 0) {
        libraryEmpty.classList.remove('hidden');
        if (state.libraryBusy) libraryEmpty.textContent = text('libraryLoading');
        else if (!libraries.length) libraryEmpty.textContent = text('libraryNoData');
        else libraryEmpty.textContent = text('libraryNoMatch');
      } else {
        libraryEmpty.classList.add('hidden');
      }
    }

    function renderConfig() {
      if (!configDump) return;
      configDump.textContent = state.configDump || text('configDumpPlaceholder');
      urlTable.innerHTML = '';
      const urls = Array.isArray(state.additionalUrls) ? state.additionalUrls : [];
      if (state.pendingRemoveIndex >= urls.length) state.pendingRemoveIndex = -1;
      urls.forEach((url, index) => {
        const tr = document.createElement('tr');
        const idx = document.createElement('td');
        idx.textContent = String(index + 1);
        tr.appendChild(idx);
        const urlCell = document.createElement('td');
        urlCell.textContent = url;
        tr.appendChild(urlCell);
        const actionCell = document.createElement('td');
        const actions = document.createElement('div');
        actions.className = 'url-actions';
        const removeBtn = document.createElement('button');
        removeBtn.className = 'subtle';
        const isPending = state.pendingRemoveIndex === index;
        removeBtn.textContent = state.configBusy
          ? text('deleting')
          : isPending
            ? text('confirmRemoveNow')
            : text('delete');
        removeBtn.disabled = state.configBusy;
        removeBtn.addEventListener('click', () => {
          if (state.configBusy) return;
          if (state.pendingRemoveIndex === index) {
            state.pendingRemoveIndex = -1;
            vscode.postMessage({ type: 'removeUrl', url, index });
          } else {
            state.pendingRemoveIndex = index;
            setStatus(text('confirmRemovePrompt'));
            renderConfig();
          }
        });
        actions.appendChild(removeBtn);
        actionCell.appendChild(actions);
        tr.appendChild(actionCell);
        urlTable.appendChild(tr);
      });
    }

    tabButtons.commands.addEventListener('click', () => switchTab('commands'));
    tabButtons.libraries.addEventListener('click', () => switchTab('libraries'));
    tabButtons.cores.addEventListener('click', () => switchTab('cores'));
    tabButtons.config.addEventListener('click', () => switchTab('config'));

    filterInput.addEventListener('input', (event) => {
      state.filter = event.target.value || '';
      renderCommands();
    });

    if (coreFilterInput) {
      coreFilterInput.addEventListener('input', (event) => {
        state.coreFilter = event.target.value || '';
        renderCores();
      });
    }

    if (coreShowInstalledToggle) {
      coreShowInstalledToggle.addEventListener('change', (event) => {
        state.coreShowInstalled = !!event.target.checked;
        renderCores();
      });
    }

    if (coreShowUpdatableToggle) {
      coreShowUpdatableToggle.addEventListener('change', (event) => {
        state.coreShowUpdatable = !!event.target.checked;
        renderCores();
      });
    }

    if (coreRefreshBtn) {
      coreRefreshBtn.addEventListener('click', () => {
        if (state.coreBusy || state.corePendingAction) return;
        requestCores(true);
      });
    }

    if (libraryFilterInput) {
      libraryFilterInput.addEventListener('input', (event) => {
        state.libraryFilter = event.target.value || '';
        renderLibraries();
      });
    }

    if (libraryShowInstalledToggle) {
      libraryShowInstalledToggle.addEventListener('change', (event) => {
        state.libraryShowInstalled = !!event.target.checked;
        renderLibraries();
      });
    }

    if (libraryShowUpdatableToggle) {
      libraryShowUpdatableToggle.addEventListener('change', (event) => {
        state.libraryShowUpdatable = !!event.target.checked;
        renderLibraries();
      });
    }

    if (libraryRefreshBtn) {
      libraryRefreshBtn.addEventListener('click', () => {
        if (state.libraryBusy || state.libraryPendingAction) return;
        requestLibraries(true);
      });
    }

    refreshBtn.addEventListener('click', () => {
      if (state.configBusy) return;
      vscode.postMessage({ type: 'refreshConfig' });
    });

    addUrlBtn.addEventListener('click', () => {
      if (state.configBusy) return;
      const value = (urlInput.value || '').trim();
      if (!value || !/^https?:\/\//i.test(value)) {
        setStatus(text('invalidUrl'));
        return;
      }
      vscode.postMessage({ type: 'addUrl', url: value });
    });

    window.addEventListener('message', (event) => {
      const message = event.data || {};
      switch (message.type) {
        case 'init':
          if (message.locale) setLocale(message.locale);
          if (Array.isArray(message.commands)) {
            state.commands = message.commands.map((cmd) => ({
              ...cmd,
              cli: typeof cmd.cli === 'string' ? cmd.cli : '',
            }));
          } else {
            state.commands = [];
          }
          state.hasProfile = !!message.hasProfile;
          state.profileLabel = message.profileLabel || '';
          state.configDump = message.configDump || '';
          state.additionalUrls = Array.isArray(message.additionalUrls) ? message.additionalUrls : [];
          state.pendingRemoveIndex = -1;
          state.cores = Array.isArray(message.cores) ? message.cores : [];
          state.coreSelections = {};
          state.coreBusy = false;
          state.corePendingAction = null;
          state.libraries = Array.isArray(message.libraries) ? message.libraries : [];
          state.librarySelections = {};
          state.libraryBusy = false;
          state.libraryPendingAction = null;
          applyStaticTexts();
          renderCommands();
          renderCores();
          renderLibraries();
          renderConfig();
          break;
        case 'profileState':
          state.hasProfile = !!message.hasProfile;
          state.profileLabel = message.profileLabel || '';
          updateProfileBadge();
          renderCommands();
          break;
        case 'coresBusy':
          state.coreBusy = !!message.value;
          if (state.coreBusy) {
            setStatus(text('statusBusy'), true);
          } else if (!state.commandRunning && !state.configBusy && !state.corePendingAction) {
            setStatus('');
          }
          renderCores();
          break;
        case 'coresData':
          state.cores = Array.isArray(message.cores) ? message.cores : [];
          state.coreBusy = false;
          {
            const nextSelections = {};
            state.cores.forEach((core) => {
              const versions = Array.isArray(core.versions) ? core.versions : [];
              const existing = state.coreSelections ? state.coreSelections[core.name] : '';
              if (existing && versions.includes(existing)) {
                nextSelections[core.name] = existing;
              } else {
                nextSelections[core.name] = core.installedVersion || core.latestVersion || versions[0] || '';
              }
            });
            state.coreSelections = nextSelections;
          }
          state.corePendingAction = null;
          renderCores();
          break;
        case 'coreCommandState':
          if (message.running) {
            state.corePendingAction = { name: message.name, action: message.action || '' };
            setStatus(text('statusBusy'), true);
          } else {
            state.corePendingAction = null;
            if (!state.coreBusy && !state.commandRunning && !state.configBusy) {
              setStatus('');
            }
          }
          renderCores();
          break;
        case 'librariesBusy':
          state.libraryBusy = !!message.value;
          if (state.libraryBusy) {
            setStatus(text('statusBusy'), true);
          } else if (!state.commandRunning && !state.configBusy && !state.libraryPendingAction) {
            setStatus('');
          }
          renderLibraries();
          break;
        case 'librariesData':
          state.libraries = Array.isArray(message.libraries) ? message.libraries : [];
          state.libraryBusy = false;
          {
            const nextSelections = {};
            state.libraries.forEach((lib) => {
              const versions = Array.isArray(lib.versions) ? lib.versions : [];
              const existing = state.librarySelections ? state.librarySelections[lib.name] : '';
              if (existing && versions.includes(existing)) {
                nextSelections[lib.name] = existing;
              } else {
                nextSelections[lib.name] = lib.installedVersion || lib.latestVersion || versions[0] || '';
              }
            });
            state.librarySelections = nextSelections;
          }
          state.libraryPendingAction = null;
          renderLibraries();
          break;
        case 'libraryCommandState':
          if (message.running) {
            state.libraryPendingAction = { name: message.name, action: message.action || '' };
            setStatus(text('statusBusy'), true);
          } else {
            state.libraryPendingAction = null;
            if (!state.libraryBusy && !state.commandRunning && !state.configBusy) {
              setStatus('');
            }
          }
          renderLibraries();
          break;
        case 'commandState':
          setCommandRunning(message.command || '', !!message.running);
          if (!message.running) {
            if (message.success) {
              setStatus('');
            } else if (message.error) {
              setStatus(text('statusError', { msg: message.error }));
            }
          }
          break;
        case 'configBusy':
          setConfigBusy(!!message.value);
          break;
        case 'configDump':
          state.configDump = message.text || '';
          state.additionalUrls = Array.isArray(message.additionalUrls) ? message.additionalUrls : [];
          state.pendingRemoveIndex = -1;
          applyStaticTexts();
          renderConfig();
          break;
        case 'status':
          if (message.key) {
            if (message.key === 'refresh') setStatus(text('statusRefresh'));
            else if (message.key === 'add') setStatus(text('statusAdd'));
            else if (message.key === 'remove') setStatus(text('statusRemove'));
          } else if (message.error) {
            setStatus(text('statusError', { msg: message.error }));
          } else if (message.message) {
            setStatus(message.message);
          }
          break;
        case 'setLocale':
          if (message.locale) setLocale(message.locale);
          break;
      }
    });

    vscode.postMessage({ type: 'ready' });
    applyStaticTexts();
    renderCommands();
    renderCores();
    renderConfig();
  </script>
</body>

</html>

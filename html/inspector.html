<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inspector</title>
  <style>
    :root {
      color-scheme: light dark;
    }

    body {
      font-family: system-ui, -apple-system, 'Segoe UI', sans-serif;
      margin: 16px;
      line-height: 1.5;
    }

    h1 {
      margin: 0 0 12px;
      font-size: 1.4rem;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      margin-bottom: 16px;
    }

    label {
      display: flex;
      flex-direction: column;
      font-size: 0.85rem;
      min-width: 180px;
    }

    select {
      padding: 6px 8px;
      font-size: 0.95rem;
    }

    button {
      padding: 6px 14px;
      font-size: 0.95rem;
      cursor: pointer;
    }

    .status {
      min-width: 160px;
      font-size: 0.9rem;
      opacity: 0.8;
    }

    .tabs {
      border-top: 1px solid rgba(128, 128, 128, 0.4);
    }

    .tab-bar {
      display: flex;
      gap: 6px;
      padding: 10px 0;
    }

    .tab-bar button {
      border: 1px solid rgba(128, 128, 128, 0.4);
      background: transparent;
      border-radius: 4px;
      padding: 6px 12px;
      color: inherit;
    }

    .tab-bar button.active {
      background: rgba(128, 128, 128, 0.15);
    }

    @media (prefers-color-scheme: dark) {
      .tab-bar button {
        color: #fff;
        border-color: rgba(255, 255, 255, 0.35);
      }

      .tab-bar button.active {
        background: rgba(255, 255, 255, 0.12);
      }
    }

    .tab {
      display: none;
    }

    .tab.active {
      display: block;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 8px 0 16px;
      font-size: 0.9rem;
    }

    th,
    td {
      border: 1px solid rgba(128, 128, 128, 0.3);
      padding: 6px 8px;
      text-align: left;
    }

    th {
      background: rgba(128, 128, 128, 0.15);
    }

    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, 'Liberation Mono', monospace;
    }

    .numeric {
      text-align: right;
    }

    pre {
      background: rgba(128, 128, 128, 0.12);
      padding: 10px;
      overflow-x: auto;
    }

    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
      margin-left: 6px;
    }

    .pill.warn {
      background: rgba(255, 193, 7, 0.2);
      color: #b07a00;
    }

    .pill.err {
      background: rgba(220, 53, 69, 0.2);
      color: #a11a2b;
    }

    .flex-row {
      display: flex;
      gap: 24px;
      flex-wrap: wrap;
    }

    .box {
      flex: 1 1 240px;
      border: 1px solid rgba(128, 128, 128, 0.3);
      border-radius: 6px;
      padding: 12px;
    }

    .box h2 {
      margin: 0 0 8px;
      font-size: 1rem;
    }

    .file-actions {
      display: flex;
      gap: 8px;
      margin: 6px 0;
      align-items: center;
    }

    .file-content {
      max-height: 360px;
      overflow: auto;
      border: 1px solid rgba(128, 128, 128, 0.3);
      padding: 8px;
    }

    .file-table {
      margin: 8px 0;
      overflow-x: auto;
    }

    .file-table.hidden {
      display: none;
    }

    .dim-note {
      opacity: 0.7;
      font-size: 0.85em;
      margin-left: 4px;
    }

    .diag-link {
      background: none;
      border: none;
      padding: 0;
      margin: 0;
      cursor: pointer;
      color: inherit;
      text-decoration: underline;
      font: inherit;
    }

    .diag-link:focus {
      outline: 1px dashed currentColor;
      outline-offset: 2px;
    }

    .hidden {
      display: none;
    }
  </style>
</head>

<body>
  <h1 id="title">Sketch Inspector</h1>
  <div class="controls">
    <label>
      <span id="labelSketch">Sketch</span>
      <select id="sketchSelect"></select>
    </label>
    <label>
      <span id="labelProfile">Profile</span>
      <select id="profileSelect"></select>
    </label>
    <button id="analyzeBtn">Analyze</button>
    <span id="status" class="status">Idle</span>
  </div>

  <div class="tabs">
    <div class="tab-bar">
      <button data-tab="summary" class="active">Summary</button>
      <button data-tab="diagnostics">Diagnostics</button>
      <button data-tab="map">Map</button>
      <button data-tab="libraries">Libraries</button>
      <button data-tab="build">Build</button>
      <button data-tab="defines">Defines</button>
      <button data-tab="files">Files</button>
      <button data-tab="raw">Raw JSON</button>
    </div>
    <div id="tab-summary" class="tab active">
      <div id="summaryContent"></div>
    </div>
    <div id="tab-diagnostics" class="tab">
      <div id="diagnosticsContent"></div>
    </div>
    <div id="tab-map" class="tab">
      <div id="mapContent"></div>
    </div>
    <div id="tab-libraries" class="tab">
      <div id="librariesContent"></div>
    </div>
    <div id="tab-build" class="tab">
      <div id="buildPropsContent"></div>
    </div>
    <div id="tab-defines" class="tab">
      <div id="definesContent"></div>
    </div>
    <div id="tab-files" class="tab">
      <div id="filesContent"></div>
    </div>
    <div id="tab-raw" class="tab">
      <pre id="rawJson" class="mono"></pre>
    </div>
  </div>

  <script>
    (function () {
      const vscode = acquireVsCodeApi();
      const state = {
        strings: {},
        sketches: [],
        files: {},
        currentAnalysis: null,
        analysisRequestId: 0,
        autoRunDone: false,
        definesText: '',
        definesMeta: null,
        pendingCopyId: ''
      };

      const titleEl = document.getElementById('title');
      const sketchSelect = document.getElementById('sketchSelect');
      const profileSelect = document.getElementById('profileSelect');
      const analyzeBtn = document.getElementById('analyzeBtn');
      const statusEl = document.getElementById('status');
      const summaryContent = document.getElementById('summaryContent');
      const diagnosticsContent = document.getElementById('diagnosticsContent');
      const mapContent = document.getElementById('mapContent');
      const librariesContent = document.getElementById('librariesContent');
      const buildPropsContent = document.getElementById('buildPropsContent');
      const definesContent = document.getElementById('definesContent');
      const filesContent = document.getElementById('filesContent');
      const rawJsonEl = document.getElementById('rawJson');
      const tabButtons = Array.from(document.querySelectorAll('.tab-bar button'));
      const tabs = {
        summary: document.getElementById('tab-summary'),
        diagnostics: document.getElementById('tab-diagnostics'),
        map: document.getElementById('tab-map'),
        libraries: document.getElementById('tab-libraries'),
        build: document.getElementById('tab-build'),
        defines: document.getElementById('tab-defines'),
        files: document.getElementById('tab-files'),
        raw: document.getElementById('tab-raw')
      };

      function setStatus(text) {
        statusEl.textContent = text;
      }

      function setStrings(strings) {
        state.strings = strings || {};
        if (strings.inspectorPanelTitle) titleEl.textContent = strings.inspectorPanelTitle;
        if (strings.inspectorSelectSketch) document.getElementById('labelSketch').textContent = strings.inspectorSelectSketch;
        if (strings.inspectorSelectProfile) document.getElementById('labelProfile').textContent = strings.inspectorSelectProfile;
        if (strings.inspectorStatusIdle) setStatus(strings.inspectorStatusIdle);
        if (strings.inspectorRunButton) analyzeBtn.textContent = strings.inspectorRunButton;
        const tabLabelMap = {
          summary: strings.inspectorTabSummary,
          diagnostics: strings.inspectorTabDiagnostics,
          map: strings.inspectorTabMap,
          libraries: strings.inspectorTabLibraries,
          build: strings.inspectorTabBuildProps,
          defines: strings.inspectorTabDefines,
          files: (strings.inspectorTabPartitions && strings.inspectorTabSdkconfig)
            ? `${strings.inspectorTabPartitions} / ${strings.inspectorTabSdkconfig}`
            : (strings.inspectorTabPartitions || strings.inspectorTabSdkconfig || 'Files'),
          raw: strings.inspectorTabRawJson
        };
        tabButtons.forEach((btn) => {
          const tabId = btn.dataset.tab;
          if (!tabId) return;
          const label = tabLabelMap[tabId];
          if (label) btn.textContent = label;
        });
      }

      function populateSketches(sketches, context) {
        state.sketches = sketches || [];
        sketchSelect.innerHTML = '';
        if (!state.sketches.length) {
          const opt = document.createElement('option');
          opt.value = '';
          opt.textContent = state.strings.inspectorStatusNoSketch || 'No sketches';
          sketchSelect.appendChild(opt);
          sketchSelect.disabled = true;
          setStatus(state.strings.inspectorStatusNoSketch || 'No sketches detected.');
          return;
        }
        sketchSelect.disabled = false;

        for (const item of state.sketches) {
          const opt = document.createElement('option');
          opt.value = item.sketchDir;
          const label = item.label;
          opt.textContent = label;
          if (item.relative && item.relative !== item.sketchDir) {
            opt.title = item.relative;
          }
          sketchSelect.appendChild(opt);
        }

        const prefer = context && context.sketchDir ? context.sketchDir : '';
        if (prefer && state.sketches.some(s => s.sketchDir === prefer)) {
          sketchSelect.value = prefer;
        } else {
          sketchSelect.selectedIndex = 0;
        }
        updateProfileSelect(context && context.profile ? context.profile : '');
        maybeAutoRun(context);
      }

      function updateProfileSelect(preferProfile) {
        const sketch = state.sketches.find(s => s.sketchDir === sketchSelect.value);
        profileSelect.innerHTML = '';
        const noneOption = document.createElement('option');
        noneOption.value = '';
        noneOption.textContent = state.strings.inspectorProfileNone || 'Use current FQBN';
        profileSelect.appendChild(noneOption);
        if (sketch && sketch.profiles && sketch.profiles.length) {
          for (const prof of sketch.profiles) {
            const opt = document.createElement('option');
            opt.value = prof;
            opt.textContent = prof;
            profileSelect.appendChild(opt);
          }
          if (preferProfile && sketch.profiles.includes(preferProfile)) {
            profileSelect.value = preferProfile;
          } else if (sketch.defaultProfile && sketch.profiles.includes(sketch.defaultProfile)) {
            profileSelect.value = sketch.defaultProfile;
          }
        }
      }

      function maybeAutoRun(context) {
        if (!context || !context.autoRun || state.autoRunDone) return;
        const targetSketch = context.sketchDir || '';
        const targetProfile = context.profile || '';
        if (!targetSketch || !targetProfile) return;
        if (sketchSelect.value !== targetSketch) return;
        const hasProfileOption = Array.from(profileSelect.options || []).some(opt => opt.value === targetProfile);
        if (!hasProfileOption) return;
        profileSelect.value = targetProfile;
        state.autoRunDone = true;
        setTimeout(() => {
          requestAnalysis();
        }, 50);
      }

      function requestAnalysis() {
        const sketchDir = sketchSelect.value;
        if (!sketchDir) {
          setStatus(state.strings.inspectorNoSelectionWarn || 'Select a sketch first.');
          return;
        }
        const requestId = Date.now();
        state.analysisRequestId = requestId;
        vscode.postMessage({
          type: 'requestAnalysis',
          sketchDir,
          profile: profileSelect.value,
          requestId
        });
      }

      function switchTab(tabId) {
        tabButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.tab === tabId));
        Object.keys(tabs).forEach(key => {
          tabs[key].classList.toggle('active', key === tabId);
        });
      }

      function renderSummary(payload) {
        const summary = payload.summary || {};
        const sections = payload.sections || [];
        const mapWarnings = (payload.map && payload.map.warnings) || [];
        const libs = payload.libraries || [];
        const str = state.strings;
        const warnPill = summary.warnings ? `<span class="pill warn">${str.inspectorSummaryWarnings || 'Warnings'}: ${summary.warnings}</span>` : '';
        const errPill = summary.errors ? `<span class="pill err">${str.inspectorSummaryErrors || 'Errors'}: ${summary.errors}</span>` : '';
        const entries = [
          { label: str.inspectorSummarySketch || 'Sketch', value: summary.relativeSketch || summary.sketchDir || '' },
          { label: str.inspectorSummaryProfile || 'Profile', value: summary.usedProfile || summary.profile || str.inspectorProfileNone || '' },
          { label: 'FQBN', value: summary.usedFqbn || '-' },
          { label: str.inspectorSummaryBuildPath || 'Build path', value: summary.buildPath || '-' },
          { label: 'Exit', value: typeof summary.exitCode === 'number' ? summary.exitCode : '' }
        ];
        const sectionRows = sections.map((s) => `<tr><td>${s.name}</td><td class="mono numeric">${s.size.toLocaleString()}</td><td class="mono numeric">${s.max ? s.max.toLocaleString() : '-'}</td></tr>`).join('');
        summaryContent.innerHTML = `
          <div class="flex-row">
            <div class="box">
              <h2>${str.inspectorTabSummary || 'Summary'} ${warnPill} ${errPill}</h2>
              <dl>
                ${entries.map(item => `<dt>${item.label}</dt><dd class="mono">${item.value || '-'}</dd>`).join('')}
              </dl>
            </div>
            <div class="box">
              <h2>${str.inspectorSectionsHeaderName || 'Section usage'}</h2>
              <table>
                <thead><tr><th>${str.inspectorSectionsHeaderName || 'Section'}</th><th class="numeric">${str.inspectorSectionsHeaderUsed || 'Used'}</th><th class="numeric">${str.inspectorSectionsHeaderMax || 'Max'}</th></tr></thead>
                <tbody>${sectionRows || `<tr><td colspan="3">${str.inspectorTableNoData || 'No data'}</td></tr>`}</tbody>
              </table>
            </div>
          </div>
          ${mapWarnings.length ? `<p>${mapWarnings.map(w => `?? ${w}`).join('<br />')}</p>` : ''}
        `;
      }

      function renderDiagnostics(diagnostics) {
        const rows = diagnostics && diagnostics.length ? diagnostics.map((d) => {
          const loc = d.file ? ((d.relative || d.file) + (d.line ? ':' + d.line : '')) : '';
          const hasFile = !!d.file;
          const hasLine = typeof d.line === 'number' && Number.isFinite(d.line);
          const hasColumn = typeof d.column === 'number' && Number.isFinite(d.column);
          const lineAttr = hasLine ? ` data-line="${d.line}"` : '';
          const columnAttr = hasColumn ? ` data-column="${d.column}"` : '';
          const locationCell = hasFile
            ? `<button type="button" class="diag-link" data-action="openLocation" data-path="${escapeAttr(d.file)}"${lineAttr}${columnAttr}>${escapeHtml(loc)}</button>`
            : escapeHtml(loc);
          return `<tr><td>${escapeHtml(d.severity)}</td><td>${escapeHtml(d.message)}</td><td class="mono">${locationCell}</td></tr>`;
        }).join('') : `<tr><td colspan="3">${state.strings.inspectorTableNoData || 'No data'}</td></tr>`;
        diagnosticsContent.innerHTML = `
          <table>
            <thead><tr><th>${state.strings.inspectorDiagnosticsHeaderSeverity || 'Severity'}</th><th>${state.strings.inspectorDiagnosticsHeaderMessage || 'Message'}</th><th>${state.strings.inspectorDiagnosticsHeaderLocation || 'Location'}</th></tr></thead>
            <tbody>${rows}</tbody>
          </table>
        `;
      }

      function renderMap(mapPayload) {
        const sections = mapPayload.sections || [];
        const symbols = mapPayload.topSymbols || [];
        const objects = mapPayload.topObjects || [];
        const sectionRows = sections.map((s) => `<tr><td>${escapeHtml(s.name)}</td><td class="mono numeric">${s.size.toLocaleString()}</td><td>${s.count}</td></tr>`).join('');
        const symbolRows = symbols.map((s) => `<tr><td>${escapeHtml(s.symbol)}</td><td class="mono">${s.size.toLocaleString()}</td><td>${escapeHtml(s.section)}</td><td class="mono">${escapeHtml(s.object)}</td></tr>`).join('');
        const objectRows = objects.map((o) => `<tr><td>${escapeHtml(o.object)}</td><td class="mono">${o.size.toLocaleString()}</td><td>${o.count}</td></tr>`).join('');
        mapContent.innerHTML = `
          <h2>${state.strings.inspectorSectionsHeaderName || 'Sections'}</h2>
          <table>
            <thead><tr><th>${state.strings.inspectorSectionsHeaderName || 'Section'}</th><th class="numeric">${state.strings.inspectorSectionsHeaderUsed || 'Used'}</th><th>#</th></tr></thead>
            <tbody>${sectionRows || `<tr><td colspan="3">${state.strings.inspectorTableNoData || 'No data'}</td></tr>`}</tbody>
          </table>
          <h2>${state.strings.inspectorTabSymbols || 'Top Symbols'}</h2>
          <table>
            <thead><tr><th>${state.strings.inspectorMapHeaderSymbol || 'Symbol'}</th><th>${state.strings.inspectorMapHeaderSize || 'Size'}</th><th>${state.strings.inspectorMapHeaderSection || 'Section'}</th><th>${state.strings.inspectorMapHeaderObject || 'Object'}</th></tr></thead>
            <tbody>${symbolRows || `<tr><td colspan="4">${state.strings.inspectorTableNoData || 'No data'}</td></tr>`}</tbody>
          </table>
          <h2>${state.strings.inspectorMapHeaderObject || 'Objects'}</h2>
          <table>
            <thead><tr><th>${state.strings.inspectorMapHeaderObject || 'Object'}</th><th>${state.strings.inspectorMapHeaderSize || 'Size'}</th><th>#</th></tr></thead>
            <tbody>${objectRows || `<tr><td colspan="3">${state.strings.inspectorTableNoData || 'No data'}</td></tr>`}</tbody>
          </table>
        `;
      }

      function renderLibraries(libraries) {
        const rows = libraries && libraries.length ? libraries.map((lib) => `<tr><td>${escapeHtml(lib.name)}</td><td>${escapeHtml(lib.version)}</td><td class="mono">${escapeHtml(lib.location || lib.installDir || '')}</td></tr>`).join('') : `<tr><td colspan="3">${state.strings.inspectorTableNoData || 'No data'}</td></tr>`;
        librariesContent.innerHTML = `
          <table>
            <thead><tr><th>${state.strings.inspectorLibrariesHeaderName || 'Library'}</th><th>${state.strings.inspectorLibrariesHeaderVersion || 'Version'}</th><th>${state.strings.inspectorLibrariesHeaderLocation || 'Source'}</th></tr></thead>
            <tbody>${rows}</tbody>
          </table>
        `;
      }

      function renderBuildProps(buildProps) {
        const rows = buildProps && buildProps.length ? buildProps.map((p) => `<tr><td>${escapeHtml(p.key)}</td><td class="mono">${escapeHtml(p.value)}</td></tr>`).join('') : `<tr><td colspan="2">${state.strings.inspectorTableNoData || 'No data'}</td></tr>`;
        buildPropsContent.innerHTML = `
          <table>
            <thead><tr><th>${state.strings.inspectorBuildPropsHeaderKey || 'Key'}</th><th>${state.strings.inspectorBuildPropsHeaderValue || 'Value'}</th></tr></thead>
            <tbody>${rows}</tbody>
          </table>
        `;
      }

      function renderDefines(defines) {
        const str = state.strings;
        state.definesMeta = defines || null;
        state.definesText = '';
        if (!defines) {
          definesContent.innerHTML = `<p>${escapeHtml(str.inspectorDefinesNoData || 'No defines generated.')}</p>`;
          return;
        }
        if (!defines.success) {
          const rawMsg = defines.error || '';
          const msg = rawMsg
            ? (str.inspectorDefinesError ? str.inspectorDefinesError.replace('{msg}', rawMsg) : rawMsg)
            : (str.inspectorDefinesNoData || 'No defines generated.');
          definesContent.innerHTML = `<p>${escapeHtml(msg)}</p>`;
          return;
        }
        const macros = typeof defines.macros === 'string' ? defines.macros : '';
        state.definesText = macros;
        const lines = macros ? macros.split(/\r?\n/) : [];
        const nonEmpty = lines.filter((line) => line.trim().length > 0).length;
        const countLabel = str.inspectorDefinesCount
          ? str.inspectorDefinesCount.replace('{count}', nonEmpty.toLocaleString())
          : `${nonEmpty} defines`;
        const copyLabel = str.inspectorDefinesCopy || 'Copy defines';
        const commandLabel = str.inspectorDefinesCommand || 'Command';
        const sourceLabel = str.inspectorDefinesSource || 'Source';
        const commandHtml = defines.command ? `<div><strong>${escapeHtml(commandLabel)}:</strong> <code>${escapeHtml(defines.command)}</code></div>` : '';
        const sourceHtml = defines.source ? `<div><strong>${escapeHtml(sourceLabel)}:</strong> <span class="mono">${escapeHtml(defines.source)}</span></div>` : '';
        definesContent.innerHTML = `
          <div class="file-actions">
            <button id="definesCopyBtn" data-action="copyDefines">${escapeHtml(copyLabel)}</button>
            <span class="dim-note">${escapeHtml(countLabel)}</span>
          </div>
          ${commandHtml}
          ${sourceHtml}
          <pre id="definesPre" class="mono">${escapeHtml(macros)}</pre>
        `;
      }

      function renderFiles(files) {
        state.files = files || {};
        const entries = Object.entries(files || {});
        if (!entries.length) {
          filesContent.innerHTML = `<p>${state.strings.inspectorTableNoData || 'No data'}</p>`;
          return;
        }
        const rows = entries.map(([key, info]) => {
          const label = key === 'partitions' ? 'partitions.csv' : key === 'sdkconfig' ? 'sdkconfig' : key;
          let actions = '';
          if (key === 'map') {
            actions = `<button data-file="${key}" data-action="open">${state.strings.inspectorOpenInEditor || 'Open in Editor'}</button>`;
          } else if (key === 'partitions' || key === 'sdkconfig') {
            actions = '';
          } else {
            actions = `<button data-file="${key}" data-action="load">${state.strings.open || 'Open'}</button>`;
          }
          const tablePlaceholder = key === 'partitions' ? `<div id="table-${key}" class="file-table hidden"></div>` : '';
          const preClasses = (key === 'partitions' || key === 'sdkconfig') ? 'file-content' : 'file-content hidden';
          const prePlaceholder = (key === 'partitions' || key === 'sdkconfig') ? (state.strings.inspectorStatusPreparing || 'Loading...') : '';
          return `<div class="file-actions"><span class="mono">${label}</span><span class="mono">${(info.size || 0).toLocaleString()} bytes</span>${actions}</div>${tablePlaceholder}<pre id="file-${key}" class="${preClasses}">${prePlaceholder}</pre>`;
        }).join('');
        filesContent.innerHTML = rows;
        const autoLoadKeys = [];
        if (entries.some(([key]) => key === 'partitions')) autoLoadKeys.push('partitions');
        if (entries.some(([key]) => key === 'sdkconfig')) autoLoadKeys.push('sdkconfig');
        for (const fileKey of autoLoadKeys) {
          vscode.postMessage({ type: 'requestFile', key: fileKey });
        }
      }

      function handleFileContent(message) {
        const key = message.key;
        const pre = document.getElementById(`file-${key}`);
        if (!pre) return;
        const tableEl = document.getElementById(`table-${key}`);
        if (message.error) {
          if (tableEl) {
            tableEl.innerHTML = '';
            tableEl.classList.add('hidden');
          }
          pre.textContent = message.error;
          pre.classList.remove('hidden');
          return;
        }
        if (key === 'partitions' && tableEl) {
          pre.textContent = message.content || '';
          const tableHtml = renderPartitionsTable(message.partitions);
          if (tableHtml) {
            tableEl.innerHTML = tableHtml;
            tableEl.classList.remove('hidden');
          } else {
            tableEl.innerHTML = '';
            tableEl.classList.add('hidden');
          }
          pre.classList.remove('hidden');
          return;
        }
        pre.textContent = message.content || '';
        pre.classList.remove('hidden');
      }

      function renderPartitionsTable(data) {
        if (!data || !Array.isArray(data.rows) || !data.rows.length) {
          return `<p>${state.strings.inspectorTableNoData || 'No data'}</p>`;
        }
        const fallbackHeaders = ['Name', 'Type', 'SubType', 'Offset', 'Size', 'Flags'];
        const headers = Array.isArray(data.headers) && data.headers.length >= 3 ? data.headers : fallbackHeaders;
        const headerCells = fallbackHeaders.map((label, idx) => `<th>${escapeHtml(headers[idx] || label)}</th>`).join('');
        const rows = data.rows.map((row) => {
          const offsetCell = formatHexDecCell(row.offsetHex, row.offsetDec, row.offsetRaw);
          const sizeCell = formatHexDecCell(row.sizeHex, row.sizeDec, row.sizeRaw);
          return `<tr><td>${escapeHtml(row.name)}</td><td>${escapeHtml(row.type)}</td><td>${escapeHtml(row.subType)}</td><td class="mono">${offsetCell}</td><td class="mono">${sizeCell}</td><td>${escapeHtml(row.flags)}</td></tr>`;
        }).join('');
        return `<table><thead><tr>${headerCells}</tr></thead><tbody>${rows}</tbody></table>`;
      }

      function formatHexDecCell(hexValue, decValue, rawValue) {
        const primary = hexValue || rawValue || '';
        if (typeof decValue === 'number' && Number.isFinite(decValue)) {
          const localeDec = decValue.toLocaleString();
          return `${escapeHtml(primary)}<span class="dim-note">(${localeDec})</span>`;
        }
        return escapeHtml(primary);
      }

      function escapeHtml(text) {
        return String(text || '').replace(/[&<>]/g, (ch) => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;' }[ch] || ch));
      }


      function escapeAttr(text) {
        return String(text || '').replace(/[&"'<>\n\r]/g, (ch) => ({
          '&': '&amp;',
          '"': '&quot;',
          "'": '&#39;',
          '<': '&lt;',
          '>': '&gt;',
          '\n': '&#10;',
          '\r': '&#13;'
        }[ch] || ch));
      }

      sketchSelect.addEventListener('change', () => updateProfileSelect(''));
      analyzeBtn.addEventListener('click', () => requestAnalysis());
      tabButtons.forEach(btn => btn.addEventListener('click', () => switchTab(btn.dataset.tab)));
      filesContent.addEventListener('click', (event) => {
        const target = event.target;
        if (!(target instanceof HTMLElement)) return;
        const key = target.getAttribute('data-file');
        const action = target.getAttribute('data-action');
        if (!key || !action) return;
        if (action === 'load') {
          vscode.postMessage({ type: 'requestFile', key });
        } else if (action === 'open') {
          vscode.postMessage({ type: 'openFile', key });
        }
      });

      definesContent.addEventListener('click', (event) => {
        const target = event.target;
        if (!(target instanceof HTMLElement)) return;
        if (target.getAttribute('data-action') !== 'copyDefines') return;
        if (!state.definesText) return;
        const requestId = `defines-${Date.now()}`;
        state.pendingCopyId = requestId;
        vscode.postMessage({ type: 'copyText', text: state.definesText, requestId });
      });

      diagnosticsContent.addEventListener('click', (event) => {
        const targetEl = event.target instanceof HTMLElement ? event.target.closest('button[data-action="openLocation"]') : null;
        if (!targetEl) return;
        const filePath = targetEl.getAttribute('data-path');
        if (!filePath) return;
        const lineAttr = targetEl.getAttribute('data-line');
        const columnAttr = targetEl.getAttribute('data-column');
        const lineValue = lineAttr ? Number(lineAttr) : undefined;
        const columnValue = columnAttr ? Number(columnAttr) : undefined;
        vscode.postMessage({
          type: 'openFile',
          path: filePath,
          line: Number.isFinite(lineValue) ? lineValue : undefined,
          column: Number.isFinite(columnValue) ? columnValue : undefined
        });
      });

      window.addEventListener('message', (event) => {
        const msg = event.data || {};
        switch (msg.type) {
          case 'init':
            setStrings(msg.strings || {});
            populateSketches(msg.sketches || [], msg.context || {});
            break;
          case 'initError':
            setStatus(msg.message || 'Init error');
            break;
          case 'analysisStatus':
            if (msg.status === 'start') setStatus(state.strings.inspectorStatusRunning || 'Analyzingï¿½c');
            break;
          case 'analysisDenied':
            setStatus(msg.message || 'Busy');
            break;
          case 'analysisResult':
            if (msg.requestId && msg.requestId !== state.analysisRequestId) return;
            if (msg.success) {
              setStatus(msg.message || state.strings.inspectorAnalysisSuccess || 'Done');
              renderSummary(msg);
              renderDiagnostics(msg.diagnostics || []);
              renderMap(msg.map || {});
              renderLibraries(msg.libraries || []);
              renderBuildProps(msg.buildProps || []);
              renderDefines(msg.defines || null);
              renderFiles(msg.files || {});
              rawJsonEl.textContent = msg.rawJson || '';
            } else {
              setStatus(msg.message || state.strings.inspectorAnalysisFailed || 'Failed');
            }
            break;
          case 'fileContent':
            handleFileContent(msg);
            break;
          case 'copyResult':
            if (msg.requestId && msg.requestId === state.pendingCopyId) {
              state.pendingCopyId = '';
              if (msg.success) {
                setStatus(state.strings.inspectorCopySuccess || 'Copied to clipboard.');
              } else if (msg.message) {
                setStatus(msg.message);
              }
            }
            break;
        }
      });

      vscode.postMessage({ type: 'ready' });
    })();
  </script>
</body>

</html>
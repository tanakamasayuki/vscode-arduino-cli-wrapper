<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Arduino CLI Boards Selector</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 20px; line-height: 1.5; }
    h1 { font-size: 1.25rem; margin: 0 0 10px; }
    .controls { display: flex; gap: 12px; align-items: center; margin-bottom: 12px; flex-wrap: wrap; }
    /* Shared style for search text boxes */
    .textbox { padding: 8px 10px; font-size: 1rem; }
    #q { flex: 1 1 260px; }
    #status { font-size: .92rem; opacity: .8; }
    ul { list-style: none; padding: 0; margin: 12px 0 0; }
    li { padding: 8px 10px; border: 1px solid #ccc; border-radius: 6px; margin-bottom: 8px; }
    .name { font-weight: 600; }
    .fqbn { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; opacity: .9; }
    .empty { opacity: .7; font-style: italic; }
    .error { color: #b00020; }
  </style>
  <!-- This page expects board_details.json generated by run.php -->
</head>
<body>
  <h1>Arduino CLI Boards Selector</h1>
  <div class="controls">
    <input id="q" class="textbox" type="search" placeholder="Filter (name or FQBN)" autocomplete="off" />
    <div id="status">Loading...</div>
  </div>
  <ul id="list" aria-live="polite"></ul>
  <div id="config" style="margin-top:16px;"></div>
  <div id="summaryBottom" class="fqbn" style="margin-top:24px; padding-top:8px; border-top:1px solid #ccc;"></div>

  <script>
    (function() {
      'use strict';
      const DATA_URL = 'https://tanakamasayuki.github.io/arduino-cli-helper/board_details.json';
      const LIB_URL = 'https://tanakamasayuki.github.io/arduino-cli-helper/libraries.json';
      const q = document.getElementById('q');
      const status = document.getElementById('status');
      const list = document.getElementById('list');

      /** @type {{fqbn:string,name:string,search:string,el:HTMLLIElement}[]} */
      let items = [];
      /** @type {Record<string, {name?:string, version?:string, config_options?: any[], package_url?: string}>} */
      let dataMap = {};
      /** @type {Array<any>|null} */
      let libsCache = null;
      /** @type {Map<string,string|true>} */
      const selectedLibs = new Map();

      function setStatus(text, isError=false) {
        status.textContent = text;
        status.className = isError ? 'error' : '';
      }

      function render(data) {
        dataMap = data || {};
        const entries = Object.entries(dataMap).map(([fqbn, v]) => ({
          fqbn,
          name: (v && typeof v.name === 'string') ? v.name : '',
        }));
        entries.sort((a, b) => a.name.localeCompare(b.name, 'en'));
        list.innerHTML = '';
        items = entries.map(({fqbn, name}) => {
          const li = document.createElement('li');
          const nameEl = document.createElement('div');
          nameEl.className = 'name';
          nameEl.textContent = name || '(No name)';
          const fqbnEl = document.createElement('div');
          fqbnEl.className = 'fqbn';
          fqbnEl.textContent = fqbn;
          li.appendChild(nameEl);
          li.appendChild(fqbnEl);
          li.addEventListener('click', () => {
            q.value = fqbn;
            applyFilter();
          });
          list.appendChild(li);
          return { fqbn, name, search: (fqbn + ' ' + name).toLowerCase(), el: li };
        });

        
        setStatus(`${items.length} items`);
      }

      function applyFilter() {
        const rawNeedle = q.value.trim();
        const needle = rawNeedle.toLowerCase();
        const exact = rawNeedle && Object.prototype.hasOwnProperty.call(dataMap, rawNeedle) ? rawNeedle : null;
        if (!needle) {
          items.forEach(it => { it.el.style.display = ''; });
          setStatus(`${items.length} items`);
          renderConfig(null, null);
          return;
        }
        if (exact) {
          let visible = 0;
          items.forEach(it => {
            const match = it.fqbn === exact;
            it.el.style.display = match ? '' : 'none';
            if (match) visible++;
          });
          setStatus(`${visible} item(s) (exact match)`);
          renderConfig(exact, dataMap[exact] || null);
        } else {
          let visible = 0;
          items.forEach(it => {
            const match = it.search.includes(needle);
            it.el.style.display = match ? '' : 'none';
            if (match) visible++;
          });
          setStatus(`${visible} / ${items.length} items`);
          renderConfig(null, null);
        }
      }

      function renderConfig(fqbn, detail) {
        const root = document.getElementById('config');
        root.innerHTML = '';
        const summaryBottom = document.getElementById('summaryBottom');
        summaryBottom.textContent = '';
        if (!fqbn || !detail) return;

        const title = document.createElement('h2');
        title.style.fontSize = '1.1rem';
        title.textContent = `Config Options: ${detail.name || ''} (${fqbn})`;
        root.appendChild(title);

        // Package URL (show above FQBN summary, no link)
        const pkgUrl = (detail && typeof detail.package_url === 'string') ? detail.package_url : '';
        if (pkgUrl) {
          const p = document.createElement('div');
          p.style.margin = '4px 0 8px';
          p.textContent = 'Package URL: ' + pkgUrl;
          root.appendChild(p);
        }

        // Summary shown just before options (below package URL)
        const summaryTop = document.createElement('div');
        summaryTop.className = 'fqbn';
        summaryTop.style.margin = '8px 0';
        root.appendChild(summaryTop);

        // YAML output UI (placed above options)
        const yamlWrap = document.createElement('div');
        yamlWrap.style.margin = '12px 0';
        const yamlLabel = document.createElement('div');
        yamlLabel.textContent = 'sketch.yaml (template)';
        yamlLabel.style.fontWeight = '600';
        yamlLabel.style.margin = '8px 0 4px';
        const yamlBox = document.createElement('textarea');
        yamlBox.id = 'yamlBox';
        yamlBox.rows = 15;
        yamlBox.style.width = '100%';
        yamlBox.style.fontFamily = 'ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace';
        yamlBox.style.tabSize = '2';
        yamlWrap.appendChild(yamlLabel);
        // Mismatch panel above textarea
        const mismatchPanel = document.createElement('div');
        mismatchPanel.style.margin = '4px 0 8px';
        mismatchPanel.style.display = 'none';
        const mmHeader = document.createElement('div');
        mmHeader.style.fontWeight = '600';
        const mmList = document.createElement('div');
        mmList.id = 'mismatchList';
        mmList.style.fontFamily = 'ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace';
        mmList.style.whiteSpace = 'pre-wrap';
        mmList.style.margin = '4px 0';
        const mmBtn = document.createElement('button');
        mmBtn.type = 'button';
        mmBtn.disabled = true;
        mismatchPanel.appendChild(mmHeader);
        mismatchPanel.appendChild(mmList);
        mismatchPanel.appendChild(mmBtn);
        yamlWrap.appendChild(mismatchPanel);
        const dlBtn = document.createElement('button');
        dlBtn.type = 'button';
        dlBtn.style.margin = '0 0 8px 0';
        const vscode = (typeof acquireVsCodeApi === 'function') ? acquireVsCodeApi() : null;
        const isJa = (navigator.language || '').toLowerCase().startsWith('ja');
        if (vscode) {
          dlBtn.textContent = isJa ? 'sketch.yaml に反映' : 'Apply to sketch.yaml';
          dlBtn.addEventListener('click', () => {
            const content = yamlBox.value || '';
            if (content) vscode.postMessage({ type: 'applyYaml', yaml: content });
          });
        } else {
          dlBtn.textContent = 'Download sketch.yaml';
          dlBtn.addEventListener('click', () => {
            const content = yamlBox.value || '';
            const blob = new Blob([content], { type: 'text/yaml;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'sketch.yaml';
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
          });
        }
        yamlWrap.appendChild(dlBtn);
        yamlWrap.appendChild(yamlBox);
        root.appendChild(yamlWrap);

        const opts = Array.isArray(detail.config_options) ? detail.config_options : [];
        if (!opts.length) {
          const p = document.createElement('p');
          p.className = 'empty';
          p.textContent = 'This board has no config_options.';
          root.appendChild(p);
          // Show base FQBN in both places even without options
          summaryTop.textContent = `${fqbn}`;
          summaryBottom.textContent = `${fqbn}`;
          return;
        }

        const groups = [];
        // Track selected platform version; prefer version from sketch.yaml init if provided
        let selectedPlatformVersion = (function(){
          try {
            const init = window.__INIT_STATE__ || {};
            const initVer = init.platformVersion || '';
            if (initVer) return initVer;
          } catch (_) {}
          return (detail && typeof detail.version === 'string' && detail.version) ? detail.version : '';
        })();
        opts.forEach((opt, idx) => {
          const groupName = `opt_${idx}`;
          const fs = document.createElement('fieldset');
          fs.style.margin = '12px 0';
          const legend = document.createElement('legend');
          const optionKey = (opt && (opt.option || opt.id || `option_${idx+1}`));
          const optionLabel = (opt && (opt.option_label || opt.label || optionKey));
          legend.textContent = String(optionLabel);
          fs.appendChild(legend);

          const values = (opt && Array.isArray(opt.values)) ? opt.values : [];
          // Determine default index (prefer is_default; fallback to 0)
          let defaultIdx = 0;
          for (let j = 0; j < values.length; j++) {
            if (values[j] && values[j].is_default) { defaultIdx = j; break; }
          }
          values.forEach((v, j) => {
            const id = `${groupName}_${j}`;
            const wrap = document.createElement('div');
            const input = document.createElement('input');
            input.type = 'radio';
            input.name = groupName;
            input.id = id;
            const valText = (v && (v.value ?? v.id ?? v.label ?? '')) + '';
            const valLabel = (v && (v.value_label ?? v.label ?? valText)) + '';
            input.value = valText;
            if (v && v.is_default) input.checked = true;
            input.dataset.groupIndex = String(idx);
            input.dataset.index = String(j);
            input.dataset.option = String(optionKey);
            input.dataset.valText = valText;
            const lab = document.createElement('label');
            lab.htmlFor = id;
            lab.textContent = valLabel + (v && v.is_default ? ' (default)' : '');
            wrap.appendChild(input);
            wrap.appendChild(lab);
            fs.appendChild(wrap);
          });

          // If none default, select first for clarity
          if (!fs.querySelector('input[type="radio"]:checked')) {
            const first = fs.querySelector('input[type="radio"]');
            if (first) first.checked = true;
          }

          // Store default index on fieldset for later comparisons
          fs.dataset.defaultIndex = String(defaultIdx);

          root.appendChild(fs);
          groups.push(fs);
        });

        function toSlug(s) {
            return (s || '').toLowerCase().replace(/[^a-z0-9_]+/g, '_').replace(/^_+|_+$/g, '') || 'default';
        }
        function buildYaml(extFqbn) {
            const parts = fqbn.split(':');
            const platformId = parts.length >= 2 ? (parts[0] + ':' + parts[1]) : fqbn;
            const platformVer = selectedPlatformVersion || '';
            const profile = toSlug(parts[2] || detail.name || parts[parts.length - 1] || 'profile');
            const lines = [];
            lines.push('profiles:');
            lines.push('  ' + profile + ':');
            lines.push('    fqbn: ' + extFqbn);
            lines.push('    platforms:');
            lines.push('      - platform: ' + platformId + (platformVer ? ` (${platformVer})` : ''));
            if (pkgUrl) {
              lines.push('        platform_index_url: ' + pkgUrl);
            }
            lines.push('    libraries:');
            if (selectedLibs.size === 0) {
              lines.push('      - ');
            } else {
              for (const [name, ver] of selectedLibs.entries()) {
                const display = typeof ver === 'string' && ver ? `${name} (${ver})` : name;
                lines.push('      - ' + display);
              }
            }
            lines.push('');
            lines.push('default_profile: ' + profile);
            return lines.join('\n');
        }
        function updateSummary() {
            // Gather selected values across groups
            const pairs = [];
            let anyChanged = false;
            groups.forEach((fs) => {
                const sel = fs.querySelector('input[type="radio"]:checked');
                if (!sel) return;
                const opt = sel.dataset.option || '';
                const val = sel.dataset.valText || '';
                const idx = Number(sel.dataset.index || '0');
                const def = Number(fs.dataset.defaultIndex || '0');
                if (idx !== def) {
                  anyChanged = true;
                  pairs.push(`${opt}=${val}`);
                }
            });
            const ext = (pairs.length && anyChanged) ? `${fqbn}:${pairs.join(',')}` : `${fqbn}`;
            if (pairs.length && anyChanged) {
                const text = ext;
                summaryTop.textContent = text;
                summaryBottom.textContent = text;
            } else {
                summaryTop.textContent = `${fqbn}`;
                summaryBottom.textContent = `${fqbn}`;
            }
            yamlBox.value = buildYaml(ext);
        }

        // Hook change events
        groups.forEach((fs) => {
            fs.addEventListener('change', updateSummary);
        });

        // Libraries UI (under options)
        const libsWrap = document.createElement('div');
        libsWrap.style.margin = '12px 0';
        const libsHeader = document.createElement('div');
        libsHeader.textContent = 'Libraries';
        libsHeader.style.fontWeight = '600';
        libsHeader.style.margin = '8px 0 4px';
        const libsControls = document.createElement('div');
        libsControls.className = 'controls';
        const libsQ = document.createElement('input');
        libsQ.type = 'search';
        libsQ.placeholder = 'Filter libraries (partial match)';
        libsQ.autocomplete = 'off';
        libsQ.className = 'textbox';
        libsQ.style.flex = '1 1 260px';
        const libsStatus = document.createElement('div');
        libsStatus.id = 'libsStatus';
        libsStatus.style.fontSize = '.92rem';
        libsStatus.style.opacity = '.8';
        libsStatus.textContent = 'Loading...';
        libsControls.appendChild(libsQ);
        const onlySel = document.createElement('input');
        onlySel.type = 'checkbox';
        onlySel.id = 'onlySelected';
        onlySel.style.marginLeft = '8px';
        const onlySelLabel = document.createElement('label');
        onlySelLabel.htmlFor = 'onlySelected';
        onlySelLabel.textContent = 'Only selected';
        onlySelLabel.style.marginLeft = '4px';
        libsControls.appendChild(onlySel);
        libsControls.appendChild(onlySelLabel);
        libsControls.appendChild(libsStatus);
        const libsList = document.createElement('ul');
        libsList.id = 'libsList';
        libsList.style.marginTop = '8px';
        libsWrap.appendChild(libsHeader);
        libsWrap.appendChild(libsControls);
        libsWrap.appendChild(libsList);
        root.appendChild(libsWrap);

        function libName(row) { return (row.name || row.Title || row.title || row.Library || '').toString(); }
        function libVersion(row) { return (row.version || row.Version || row.library_version || '').toString(); }

        function ensureDefaultLibsForBoard() {
          if (!/m5stack/i.test(fqbn)) return;
          // Prefer version if available
          const findVersion = (target) => {
            if (!Array.isArray(libsCache)) return '';
            for (const row of libsCache) {
              if (libName(row) === target) return libVersion(row) || '';
            }
            return '';
          };
          const m5uVer = findVersion('M5Unified');
          const m5gfxVer = findVersion('M5GFX');
          selectedLibs.set('M5Unified', m5uVer || true);
          selectedLibs.set('M5GFX', m5gfxVer || true);
        }
        function findLatestVersionByName(targetName) {
          if (!Array.isArray(libsCache)) return '';
          for (const row of libsCache) {
            if (libName(row) === targetName) return libVersion(row) || '';
          }
          return '';
        }
        function collectVersionMismatches() {
          const mismatches = [];
          for (const [name, ver] of selectedLibs.entries()) {
            if (typeof ver !== 'string' || !ver) continue; // only when YAML specified a version
            const latest = findLatestVersionByName(name);
            if (latest && latest !== ver) {
              mismatches.push({ name, current: ver, latest });
            }
          }
          return mismatches;
        }
        function renderLibs() {
          libsList.innerHTML = '';
          if (!Array.isArray(libsCache)) { libsStatus.textContent = 'Load error'; return; }
          // Ensure defaults (e.g., M5 libs) are selected for this board
          ensureDefaultLibsForBoard();
          const term = libsQ.value.trim().toLowerCase();
          let visible = 0;
          libsCache.forEach((row, idx) => {
            const name = libName(row);
            const ver = libVersion(row);
            const text = (name + ' ' + ver).toLowerCase();
            if (term && !text.includes(term)) return;
            if (onlySel.checked && !selectedLibs.has(name)) return;
            const li = document.createElement('li');
            const id = 'lib_' + idx;
            const cb = document.createElement('input');
            cb.type = 'checkbox';
            cb.id = id;
            cb.checked = selectedLibs.has(name);
            cb.addEventListener('change', () => {
              if (cb.checked) { selectedLibs.set(name, ver || true); } else { selectedLibs.delete(name); }
              updateSummary();
              try { updateMismatches(); } catch (_) {}
            });
            const lab = document.createElement('label');
            lab.htmlFor = id;
            lab.textContent = ver ? `${name} (${ver})` : name;
            li.appendChild(cb);
            li.appendChild(lab);
            libsList.appendChild(li);
            visible++;
          });
          libsStatus.textContent = `${visible} item(s)`;
          try { updateMismatches(); } catch (_) {}
        }
        libsQ.addEventListener('input', renderLibs);
        onlySel.addEventListener('change', renderLibs);
        if (libsCache === null) {
          fetch(LIB_URL + '?v=' + Date.now(), { cache: 'no-store' })
            .then(r => { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
            .then(json => {
              libsCache = Array.isArray(json) ? json : [];
              // Re-apply defaults now that versions are known
              ensureDefaultLibsForBoard();
              renderLibs();
              updateSummary();
            })
            .catch(() => { libsCache = []; renderLibs(); });
        } else {
          ensureDefaultLibsForBoard();
          renderLibs();
        }

        // Initial render
        updateSummary();
        try { updateMismatches(); } catch (_) {}

        // Helpers to compute mismatches and update the mismatch panel
        function findLatestVersionByName(targetName) {
          if (!Array.isArray(libsCache)) return '';
          for (const row of libsCache) { if (libName(row) === targetName) return libVersion(row) || ''; }
          return '';
        }
        function collectLibVersionMismatches() {
          const mismatches = [];
          for (const [name, ver] of selectedLibs.entries()) {
            if (typeof ver !== 'string' || !ver) continue;
            const latest = findLatestVersionByName(name);
            if (latest && latest !== ver) mismatches.push({ type: 'lib', name, current: ver, latest });
          }
          return mismatches;
        }
        function collectPlatformMismatch() {
          try {
            const init = window.__INIT_STATE__ || {};
            const initId = init.platformId || '';
            const initVer = init.platformVersion || '';
            const parts = fqbn.split(':');
            const platformId = parts.length >= 2 ? (parts[0] + ':' + parts[1]) : fqbn;
            const latestVer = (detail && typeof detail.version === 'string') ? detail.version : '';
            if (initId && platformId && initId === platformId && initVer && latestVer && initVer !== latestVer) {
              return { type: 'platform', name: platformId, current: initVer, latest: latestVer };
            }
          } catch (_) {}
          return null;
        }
        function updateMismatches() {
          const ja = (navigator.language || '').toLowerCase().startsWith('ja');
          const platformMM = collectPlatformMismatch();
          const libMM = collectLibVersionMismatches();
          const lines = [];
          if (platformMM) lines.push((ja ? 'プラットフォーム' : 'Platform') + ` ${platformMM.name}: ${platformMM.current} -> ${platformMM.latest}`);
          libMM.forEach(m => lines.push(`${m.name}: ${m.current} -> ${m.latest}`));
          mmList.textContent = lines.join('\n');
          const count = lines.length;
          mmHeader.textContent = ja ? '更新可能な項目' : 'Updates available';
          mmBtn.textContent = (ja ? '最新に更新' : 'Update to latest') + (count ? ` (${count})` : '');
          mmBtn.disabled = count === 0;
          mismatchPanel.style.display = count ? '' : 'none';
        }
        mmBtn.addEventListener('click', () => {
          const ja = (navigator.language || '').toLowerCase().startsWith('ja');
          // Update libraries to latest
          const libMM = collectLibVersionMismatches();
          libMM.forEach(({ name, latest }) => { if (latest) selectedLibs.set(name, latest); });
          // Ask for platform update when mismatch exists
          const plat = collectPlatformMismatch();
          if (plat) {
            const ok = window.confirm(ja ? `プラットフォーム ${plat.name} を最新に更新しますか？\n現在: ${plat.current}\n最新: ${plat.latest}` : `Update platform ${plat.name} to latest?\nCurrent: ${plat.current}\nLatest: ${plat.latest}`);
            if (ok) {
              selectedPlatformVersion = plat.latest;
            } else {
              selectedPlatformVersion = plat.current;
            }
          }
          renderLibs();
          updateSummary();
          updateMismatches();
        });
      }

      q.addEventListener('input', applyFilter);

      // Load data
      fetch(DATA_URL + '?v=' + Date.now(), { cache: 'no-store' })
        .then(resp => {
          if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
          return resp.json();
        })
        .then(json => {
          render(json);
          applyFilter();
        })
        .catch(err => {
          list.innerHTML = '';
          const li = document.createElement('li');
          li.className = 'empty';
          li.textContent = 'Could not load data. Please run run.php first.';
          list.appendChild(li);
          setStatus(`Load error: ${err.message}`, true);
        });

      // VS Code integration: preselect board options and libraries from current profile
      window.addEventListener('message', (ev) => {
        const data = ev && ev.data || {};
        if (!data || data.type !== 'init') return;
        try {
          // Store initial platform info
          window.__INIT_STATE__ = { platformId: String(data.platformId||''), platformVersion: String(data.platformVersion||'') };
          const extFqbn = String(data.extFqbn || '');
          if (!extFqbn) return;
          // Base FQBN is vendor:arch:board (first 3 segments)
          const parts = extFqbn.split(':');
          const baseFqbn = parts.slice(0, 3).join(':');
          const pairsText = parts.slice(3).join(':');
          q.value = baseFqbn;
          applyFilter();
          // Apply option selections
          if (pairsText) {
            const pairs = pairsText.split(',').map(s => s.trim()).filter(Boolean);
            const esc = (s) => {
              try { return (window.CSS && CSS.escape) ? CSS.escape(s) : s.replace(/[^a-zA-Z0-9_-]/g, '\\$&'); } catch (_) { return s; }
            };
            pairs.forEach(p => {
              const kv = p.split('=');
              if (kv.length < 2) return;
              const key = kv[0];
              const val = kv.slice(1).join('=');
              const selector = `#config input[type="radio"][data-option="${esc(key)}"][data-val-text="${esc(val)}"]`;
              const input = document.querySelector(selector);
              if (input) {
                input.checked = true;
                input.dispatchEvent(new Event('change', { bubbles: true }));
              }
            });
          }
          // Apply libraries selection
          if (Array.isArray(data.libraries)) {
            selectedLibs.clear();
            data.libraries.forEach(row => {
              const name = (row && row.name) ? String(row.name) : '';
              const ver = (row && row.version) ? String(row.version) : '';
              if (name) selectedLibs.set(name, ver || true);
            });
            // If library list already loaded, re-render and update summary
            try { if (libsCache !== null) { renderLibs(); } } catch (_) {}
            try { updateSummary(); } catch (_) {}
            try { if (typeof updateMismatches === 'function') updateMismatches(); } catch (_) {}
          }
        } catch (_) { /* ignore */ }
      });
    })();
  </script>
</body>
</html>
